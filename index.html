<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SetGroom — System Produkcji</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBcigGPIF4t8gWBB8EwurMZaEhyOCJxnzY",
  authDomain: "setgroom.firebaseapp.com",
  projectId: "setgroom",
  storageBucket: "setgroom.firebasestorage.app",
  messagingSenderId: "117814552948",
  appId: "1:117814552948:web:e11e71146b65b4df122421"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// Expose to global scope so main script can use it
window._db         = db;
window._doc        = doc;
window._setDoc     = setDoc;
window._onSnapshot = onSnapshot;
window._collection = collection;
window._getDocs    = getDocs;
window._firebaseReady = true;
window.dispatchEvent(new Event('firebase-ready'));
</script>
<style>
:root {
  --bg: #f7f5f0;
  --surface: #ffffff;
  --card: #f0ece3;
  --border: #e4ddd0;
  --border2: #cfc5b0;
  --accent: #1e3d0f;
  --accent-mid: #2d5a18;
  --accent-light: #3d7a20;
  --accent-bg: #eaf3e2;
  --amber: #b86e10;
  --amber-bg: #fef0d8;
  --red: #b52d20;
  --red-bg: #fce8e6;
  --text: #18140e;
  --text2: #4a4030;
  --muted: #8a7f6e;
  --shadow: 0 2px 10px rgba(30,61,15,0.07);
  --shadow-lg: 0 8px 28px rgba(30,61,15,0.13);
  --header-h: 60px;
  --bottom-nav-h: 72px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body { height: 100%; overflow: hidden; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  display: flex;
  flex-direction: column;
}

/* ===================== LOGIN SCREEN ===================== */
#login-screen {
  position: fixed;
  inset: 0;
  background: var(--accent);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 24px;
}

#login-screen::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 30% 20%, rgba(61,122,32,0.4) 0%, transparent 60%),
              radial-gradient(ellipse at 80% 80%, rgba(30,61,15,0.6) 0%, transparent 50%);
  pointer-events: none;
}

.login-logo {
  font-family: 'Syne', sans-serif;
  font-size: 2.8rem;
  font-weight: 800;
  color: white;
  letter-spacing: -1px;
  margin-bottom: 6px;
  position: relative;
  z-index: 1;
}

.login-logo span { color: #8fcf5a; }

.login-sub {
  color: rgba(255,255,255,0.55);
  font-size: 0.8rem;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  margin-bottom: 52px;
  position: relative;
  z-index: 1;
}

.login-label {
  color: rgba(255,255,255,0.6);
  font-size: 0.78rem;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: 16px;
  position: relative;
  z-index: 1;
}

.login-cards {
  display: flex;
  gap: 16px;
  position: relative;
  z-index: 1;
  flex-wrap: wrap;
  justify-content: center;
  width: 100%;
  max-width: 460px;
}

.login-card {
  flex: 1;
  min-width: 180px;
  background: rgba(255,255,255,0.08);
  border: 1.5px solid rgba(255,255,255,0.15);
  border-radius: 18px;
  padding: 28px 20px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  backdrop-filter: blur(10px);
}

.login-card:hover, .login-card:active {
  background: rgba(255,255,255,0.16);
  border-color: rgba(255,255,255,0.4);
  transform: translateY(-3px);
  box-shadow: 0 16px 40px rgba(0,0,0,0.3);
}

.login-card-icon { font-size: 2.6rem; margin-bottom: 12px; }
.login-card-name {
  font-family: 'Syne', sans-serif;
  font-size: 1.3rem;
  font-weight: 700;
  color: white;
  margin-bottom: 6px;
}
.login-card-desc { font-size: 0.78rem; color: rgba(255,255,255,0.5); line-height: 1.4; }

/* ===================== HEADER ===================== */
header {
  background: var(--accent);
  color: white;
  height: var(--header-h);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  position: sticky;
  top: 0;
  z-index: 100;
  flex-shrink: 0;
  box-shadow: 0 2px 12px rgba(30,61,15,0.25);
}

.logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 1.25rem;
  letter-spacing: -0.5px;
  color: white;
  flex-shrink: 0;
}

.logo span { color: #8fcf5a; }

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-pill {
  background: rgba(255,255,255,0.15);
  border-radius: 20px;
  padding: 5px 12px 5px 8px;
  display: flex;
  align-items: center;
  gap: 7px;
  font-size: 0.82rem;
  color: white;
  font-weight: 500;
}

.user-pill-icon { font-size: 1rem; }

.btn-logout {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: rgba(255,255,255,0.7);
  border-radius: 8px;
  padding: 5px 10px;
  font-size: 0.75rem;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  transition: all 0.15s;
}
.btn-logout:hover { background: rgba(255,255,255,0.2); color: white; }

/* Desktop nav */
.desktop-nav {
  display: flex;
  gap: 2px;
}

.nav-tab {
  padding: 7px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.82rem;
  font-weight: 500;
  color: rgba(255,255,255,0.6);
  transition: all 0.18s;
  border: none;
  background: transparent;
  font-family: 'Outfit', sans-serif;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.nav-tab:hover { color: white; background: rgba(255,255,255,0.1); }
.nav-tab.active { color: white; background: rgba(255,255,255,0.18); }

.nav-badge {
  background: var(--amber);
  color: white;
  border-radius: 10px;
  padding: 1px 6px;
  font-size: 0.68rem;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  min-width: 18px;
  text-align: center;
}

/* ===================== MAIN SCROLL ===================== */
#app-shell {
  display: none;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
}

.main-scroll {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 24px 20px;
  padding-bottom: calc(var(--bottom-nav-h) + 20px);
}

/* ===================== BOTTOM NAV (mobile) ===================== */
.bottom-nav {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: var(--bottom-nav-h);
  background: var(--accent);
  border-top: 2px solid rgba(143,207,90,0.3);
  z-index: 100;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
}

.bottom-nav-inner {
  display: flex;
  height: 100%;
  align-items: stretch;
  max-width: 600px;
  margin: 0 auto;
  width: 100%;
}

.bnav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 5px;
  cursor: pointer;
  color: rgba(255,255,255,0.45);
  transition: all 0.15s;
  position: relative;
  border: none;
  background: transparent;
  font-family: 'Outfit', sans-serif;
  -webkit-tap-highlight-color: transparent;
  padding: 8px 0;
}

.bnav-item.active {
  color: white;
  background: rgba(255,255,255,0.08);
}

.bnav-item.active::before {
  content: '';
  position: absolute;
  top: 0; left: 15%; right: 15%;
  height: 3px;
  background: #8fcf5a;
  border-radius: 0 0 4px 4px;
}

.bnav-icon {
  font-size: 1.55rem;
  line-height: 1;
  position: relative;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
}

.bnav-label {
  font-size: 0.68rem;
  font-weight: 600;
  letter-spacing: 0.3px;
  text-transform: uppercase;
}

.bnav-badge {
  position: absolute;
  top: 6px; right: calc(50% - 22px);
  background: var(--amber);
  color: white;
  border-radius: 9px;
  padding: 0 5px;
  font-size: 0.62rem;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  min-width: 18px;
  text-align: center;
  line-height: 18px;
  height: 18px;
  border: 2px solid var(--accent);
}

/* ===================== VIEWS ===================== */
.view { display: none; }
.view.active { display: block; }

/* ===================== PAGE HEADER ===================== */
.page-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}

.page-title {
  font-family: 'Syne', sans-serif;
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--accent);
  letter-spacing: -0.3px;
}

.page-subtitle { font-size: 0.82rem; color: var(--muted); margin-top: 2px; }

/* ===================== BUTTONS ===================== */
.btn {
  padding: 10px 18px;
  border-radius: 10px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.88rem;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all 0.18s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  -webkit-tap-highlight-color: transparent;
}

.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover, .btn-primary:active { background: var(--accent-light); }

.btn-secondary { background: var(--surface); color: var(--text2); border: 1px solid var(--border2); }
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

.btn-success { background: var(--accent-bg); color: var(--accent-mid); border: 1px solid rgba(45,90,24,0.2); }
.btn-success:hover { background: var(--accent-mid); color: white; }

.btn-danger { background: var(--red-bg); color: var(--red); border: 1px solid transparent; }
.btn-danger:hover { border-color: var(--red); }

.btn-sm { padding: 6px 12px; font-size: 0.78rem; }
.btn-full { width: 100%; justify-content: center; padding: 14px; font-size: 0.95rem; }

/* ===================== STATS ===================== */
.stats-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px 18px;
  box-shadow: var(--shadow);
}

.stat-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 500; margin-bottom: 6px; }
.stat-value { font-family: 'Syne', sans-serif; font-size: 1.9rem; font-weight: 800; color: var(--accent); line-height: 1; }
.stat-sub { font-size: 0.7rem; color: var(--muted); margin-top: 3px; }
.stat-card.warn .stat-value { color: var(--amber); }
.stat-card.danger .stat-value { color: var(--red); }

.stat-clickable {
  cursor: pointer;
  transition: all 0.18s;
  user-select: none;
}
.stat-clickable:hover {
  border-color: var(--accent-mid);
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}
.stat-clickable:active { transform: translateY(0); }
.stat-clickable .stat-sub { color: var(--accent-mid); font-weight: 500; }
.stat-card.warn.stat-clickable:hover { border-color: var(--amber); }
.stat-card.danger.stat-clickable:hover { border-color: var(--red); }

/* ===================== ORDER PANEL ===================== */
.order-form-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
}

.panel-title {
  font-family: 'Syne', sans-serif;
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 7px;
}

/* ===================== FORM ===================== */
.form-group { margin-bottom: 14px; }
.form-group:last-child { margin-bottom: 0; }

.form-group label {
  display: block;
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 5px;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 11px 14px;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.92rem;
  color: var(--text);
  background: var(--bg);
  outline: none;
  transition: border-color 0.18s, box-shadow 0.18s;
  -webkit-appearance: none;
}

.form-group input:focus,
.form-group select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(30,61,15,0.09); }
.form-group input.error { border-color: var(--red); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* ===================== QTY CONTROL ===================== */
.qty-control {
  display: flex;
  align-items: center;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  overflow: hidden;
  background: var(--bg);
  width: 120px;
}

.qty-control button {
  width: 36px;
  height: 42px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 1.1rem;
  color: var(--text2);
  transition: background 0.15s;
  flex-shrink: 0;
}

.qty-control button:active { background: var(--card); }

.qty-control input {
  flex: 1;
  text-align: center;
  border: none !important;
  background: transparent !important;
  padding: 0 !important;
  font-size: 0.9rem;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
  color: var(--text);
  outline: none;
  box-shadow: none !important;
  width: 44px;
}

/* ===================== PRIORITY ===================== */
.prio-select { display: flex; gap: 6px; }

.prio-opt {
  flex: 1;
  padding: 8px 4px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  text-align: center;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  color: var(--muted);
  background: var(--bg);
}

.prio-opt.selected[data-p="1"] { background: var(--red-bg); border-color: var(--red); color: var(--red); }
.prio-opt.selected[data-p="2"] { background: var(--amber-bg); border-color: var(--amber); color: var(--amber); }
.prio-opt.selected[data-p="3"] { background: var(--accent-bg); border-color: var(--accent-mid); color: var(--accent-mid); }

/* ===================== SKU AUTOCOMPLETE ===================== */
.sku-input-wrap { position: relative; }

.sku-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--surface);
  border: 1.5px solid var(--accent);
  border-radius: 10px;
  box-shadow: var(--shadow-lg);
  z-index: 200;
  max-height: 240px;
  overflow-y: auto;
}

.sku-option {
  padding: 11px 14px;
  cursor: pointer;
  font-size: 0.88rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.1s;
  border-bottom: 1px solid var(--border);
}

.sku-option:last-child { border-bottom: none; }
.sku-option:hover, .sku-option:active { background: var(--card); }
.sku-option .so-sku { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--accent-mid); }
.sku-option .so-name { color: var(--text); font-weight: 500; font-size: 0.85rem; }
.sku-option .so-stock { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; }

/* ===================== ORDER RESULT ===================== */
.order-result {
  background: var(--card);
  border: 1.5px solid var(--border2);
  border-radius: 10px;
  padding: 14px 16px;
  margin-top: 12px;
  font-size: 0.87rem;
}

.order-result.success { background: var(--accent-bg); border-color: rgba(30,61,15,0.2); }
.order-result.added { background: var(--amber-bg); border-color: rgba(184,110,16,0.2); }

.order-result-title {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.order-result.success .order-result-title { color: var(--accent-mid); }
.order-result.added .order-result-title { color: var(--amber); }
.order-result p { color: var(--text2); line-height: 1.5; font-size: 0.84rem; }

/* ===================== TARTAN ===================== */

.tartan-colors {
  padding: 14px 16px;
  background: var(--accent-bg);
  border: 1.5px solid rgba(45,90,24,0.2);
  border-radius: 9px;
  animation: slideUp 0.2s ease;
}

.tartan-colors-auto {
  border-color: var(--amber);
  background: var(--amber-bg);
  position: relative;
}

.tartan-colors-auto::before {
  content: '';
  position: absolute;
  top: -6px; left: 16px;
  width: 10px; height: 10px;
  background: var(--amber-bg);
  border-left: 1.5px solid var(--amber);
  border-top: 1.5px solid var(--amber);
  transform: rotate(45deg);
}

.tartan-colors-label {
  font-size: 0.72rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text2);
  margin-bottom: 12px;
}

.tartan-dots {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.tartan-dot {
  width: 36px; height: 36px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  box-shadow: 0 2px 6px rgba(0,0,0,0.18);
  transition: all 0.15s;
  position: relative;
  flex-shrink: 0;
}
.tartan-dot:hover { transform: scale(1.15); box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
.tartan-dot.selected {
  border-color: var(--text);
  transform: scale(1.18);
  box-shadow: 0 4px 14px rgba(0,0,0,0.3);
}
.tartan-dot.selected::after {
  content: '✓';
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.85rem;
  font-weight: 700;
  text-shadow: 0 1px 3px rgba(0,0,0,0.4);
}

.tartan-selected-name {
  margin-top: 10px;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--accent-mid);
  min-height: 18px;
}

.queue-chip.tartan {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  color: white;
  font-weight: 700;
}


/* ===================== QUEUE ===================== */
.queue-list { display: flex; flex-direction: column; gap: 10px; }

.queue-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  box-shadow: var(--shadow);
  animation: slideUp 0.25s ease;
}

@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.queue-item.done { opacity: 0.45; border-style: dashed; }
/* ===================== STATUS BADGES ===================== */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.72rem;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.3px;
  white-space: nowrap;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
}

.status-nowe       { background: #e8f4fd; color: #1565c0; border: 1.5px solid #90caf9; }
.status-w-produkcji { background: #fff8e1; color: #e65100; border: 1.5px solid #ffcc02; }
.status-tartanowanie { background: #f3e5f5; color: #6a1b9a; border: 1.5px solid #ce93d8; }
.status-zakonczone  { background: #e8f5e9; color: #1b5e20; border: 1.5px solid #81c784; }

.status-badge:hover { filter: brightness(0.92); transform: scale(1.03); }

/* STATUS MENU */
.status-menu {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  background: var(--surface);
  border: 1.5px solid var(--border2);
  border-radius: 10px;
  box-shadow: var(--shadow-lg);
  z-index: 300;
  min-width: 200px;
  overflow: hidden;
  animation: slideUp 0.15s ease;
}

.status-menu-item {
  padding: 10px 14px;
  cursor: pointer;
  font-size: 0.84rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background 0.1s;
  border-bottom: 1px solid var(--border);
}
.status-menu-item:last-child { border-bottom: none; }
.status-menu-item:hover { background: var(--card); }
.status-menu-item.active { font-weight: 700; }
.status-wrap { position: relative; display: inline-block; }

/* SIZE GROUP HEADERS */
.size-group-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 20px 0 10px;
}

.size-group-title {
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 800;
  color: var(--accent);
  letter-spacing: 1px;
}

.size-group-badge {
  background: var(--accent);
  color: white;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 4px;
}

.size-group-badge.tartan { background: #6a1b9a; }
.size-group-badge.standard { background: var(--accent-mid); }

.size-group-line {
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* QUEUE ITEM — status border accent */
.queue-item.status-w-produkcji  { border-left: 3px solid #ffcc02; }
.queue-item.status-tartanowanie { border-left: 3px solid #ce93d8; }
.queue-item.status-zakonczone   { border-left: 3px solid #81c784; opacity: 0.6; }
.queue-item.status-nowe         { border-left: 3px solid #90caf9; }


.qi-top {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.queue-pos {
  width: 38px;
  height: 38px;
  background: var(--accent);
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 800;
  color: white;
  flex-shrink: 0;
}

.queue-pos.high { background: var(--red); }
.queue-pos.low { background: var(--muted); }

.qi-name { font-weight: 600; font-size: 0.92rem; flex: 1; }

.qi-meta {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.queue-chip {
  font-size: 0.68rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  background: var(--card);
  padding: 2px 8px;
  border-radius: 4px;
  border: 1px solid var(--border);
}

.queue-chip.qty { color: var(--accent-mid); background: var(--accent-bg); border-color: rgba(45,90,24,0.15); }
.queue-chip.deadline { color: var(--amber); background: var(--amber-bg); border-color: rgba(184,110,16,0.2); }
.queue-chip.deadline.urgent { color: var(--red); background: var(--red-bg); border-color: rgba(181,45,32,0.2); }
.queue-chip.who { color: var(--accent-mid); }

.qi-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ===================== TABLE (catalog/stock) ===================== */
.table-wrap {
  overflow-x: auto;
  border-radius: 12px;
  box-shadow: var(--shadow);
  -webkit-overflow-scrolling: touch;
}

table { width: 100%; border-collapse: collapse; background: var(--surface); min-width: 500px; }

thead tr { background: var(--card); border-bottom: 2px solid var(--border); }

th {
  padding: 11px 14px;
  text-align: left;
  font-size: 0.68rem;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  white-space: nowrap;
}

td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 0.88rem; vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--card); }

.sku-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.74rem;
  background: var(--accent-bg);
  color: var(--accent-mid);
  padding: 3px 8px;
  border-radius: 5px;
  font-weight: 500;
  border: 1px solid rgba(45,90,24,0.15);
  white-space: nowrap;
}

.stock-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.74rem;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
  white-space: nowrap;
}

.stock-ok { background: var(--accent-bg); color: var(--accent-mid); }
.stock-low { background: var(--amber-bg); color: var(--amber); }
.stock-out { background: var(--red-bg); color: var(--red); }

/* ===================== MODAL ===================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(18,14,10,0.55);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: 0;
  animation: fadeIn 0.15s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.modal {
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-width: 540px;
  animation: sheetUp 0.25s ease;
  border: 1px solid var(--border);
  max-height: 90vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.modal-handle {
  width: 36px; height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 12px auto 0;
}

.modal-header { padding: 16px 20px 0; display: flex; align-items: center; justify-content: space-between; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--accent); }
.modal-close {
  width: 30px; height: 30px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: transparent;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: var(--muted);
  font-size: 1rem;
  transition: all 0.15s;
}
.modal-close:hover { background: var(--red-bg); color: var(--red); }

.modal-body { padding: 16px 20px; }
.modal-footer { padding: 0 20px 24px; display: flex; gap: 8px; justify-content: flex-end; }

/* ===================== MISC ===================== */
.section-title {
  font-family: 'Syne', sans-serif;
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--muted);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.empty {
  text-align: center;
  padding: 48px 20px;
  color: var(--muted);
}

.empty-icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.35; }
.empty-title { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700; margin-bottom: 5px; color: var(--text2); }
.empty-sub { font-size: 0.82rem; }

.search-bar { margin-bottom: 16px; }
.search-bar input {
  width: 100%;
  padding: 10px 16px;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.9rem;
  background: var(--surface);
  outline: none;
  transition: border-color 0.18s;
  color: var(--text);
  -webkit-appearance: none;
}
.search-bar input:focus { border-color: var(--accent); }

/* NOTIFICATION */
.notification {
  position: fixed;
  bottom: calc(var(--bottom-nav-h) + 12px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: white;
  padding: 12px 20px;
  border-radius: 50px;
  font-size: 0.85rem;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  z-index: 2000;
  animation: notifIn 0.25s ease;
  white-space: nowrap;
  max-width: calc(100vw - 40px);
  text-overflow: ellipsis;
  overflow: hidden;
}

@keyframes notifIn { from { opacity:0; transform: translateX(-50%) translateY(10px); } to { opacity:1; transform: translateX(-50%) translateY(0); } }
@keyframes tartanPulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.3); box-shadow: 0 0 0 4px rgba(184,110,16,0.4); } }

.notification.warn { background: var(--amber); }
.notification.error { background: var(--red); }

/* REFRESH indicator */
.refresh-dot {
  width: 8px; height: 8px;
  background: #8fcf5a;
  border-radius: 50%;
  display: inline-block;
  animation: blink 2s ease-in-out infinite;
}

@keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0.3; } }

/* RECENT orders list */
.recent-list { display: flex; flex-direction: column; gap: 8px; }
.recent-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 9px;
  padding: 10px 12px;
  font-size: 0.83rem;
}
.recent-item-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 5px; }
.recent-item-name { font-weight: 600; color: var(--text); }
.recent-item-time { font-size: 0.68rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; white-space: nowrap; flex-shrink: 0; }
.recent-chips { display: flex; gap: 5px; flex-wrap: wrap; }

/* DESKTOP LAYOUT */
@media (min-width: 768px) {
  .main-scroll { padding-bottom: 24px; padding: 28px 32px; }
  .bottom-nav { display: none !important; }
  .desktop-nav { display: flex; }
  .stats-row { grid-template-columns: repeat(4, 1fr); }
  .order-desktop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .modal-overlay { align-items: center; padding: 20px; }
  .modal { border-radius: 16px; max-width: 560px; }
  @keyframes sheetUp { from { opacity:0; transform: translateY(16px); } to { opacity:1; transform: translateY(0); } }
  .modal-handle { display: none; }
  .notification { bottom: 24px; }
}

@media (max-width: 767px) {
  .bottom-nav { display: block; }
  .desktop-nav { display: none; }
  header { padding: 0 12px; height: auto; min-height: var(--header-h); flex-wrap: nowrap; gap: 8px; }
  .main-scroll { padding: 16px 16px calc(var(--bottom-nav-h) + 20px); }
  .order-desktop-grid { display: block; }
  .order-desktop-grid > .order-form-card:first-child { margin-bottom: 16px; }

  /* Compact header-right on mobile */
  .header-right { gap: 6px; flex-shrink: 0; }

  /* Hide text in user-pill — show only icon */
  .user-pill { padding: 5px 8px; gap: 0; }
  .user-pill #user-name-header { display: none; }

  /* Hide refresh dot on mobile */
  .refresh-dot { display: none; }

  /* Compact logout — icon only */
  .btn-logout .btn-logout-text { display: none; }
  .btn-logout { padding: 6px 8px; font-size: 0.8rem; }

  /* Compact POS button */
  .btn-pos .btn-pos-text { display: none; }
  .btn-pos { padding: 7px 10px; font-size: 0.95rem; }
}


/* ===================== QUEUE FILTER BAR ===================== */
.queue-filter-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.filter-btn {
  padding: 7px 14px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  font-family: 'Outfit', sans-serif;
  cursor: pointer;
  border: 1.5px solid var(--border2);
  background: var(--surface);
  color: var(--muted);
  transition: all 0.15s;
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}
.filter-btn:hover { border-color: var(--accent-mid); color: var(--text); }
.filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
.filter-btn .filter-count {
  background: rgba(255,255,255,0.25);
  border-radius: 10px;
  padding: 0 6px;
  font-size: 0.68rem;
  font-family: 'JetBrains Mono', monospace;
}
.filter-btn:not(.active) .filter-count {
  background: var(--card);
  color: var(--muted);
}

/* Fix size-group badge — no color confusion */
.size-group-badge {
  background: var(--text2) !important;
  color: white !important;
}
.size-group-badge.tartan { background: var(--text2) !important; }
.size-group-badge.standard { background: var(--text2) !important; }

/* Queue item clickable */
.queue-item-clickable {
  cursor: pointer;
}
.queue-item-clickable:hover {
  border-color: var(--accent-mid) !important;
  box-shadow: var(--shadow-lg);
}

/* ===================== ORDER DETAIL MODAL ===================== */
#modal-order .modal { max-width: 540px; }

.order-detail-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 16px;
}

.order-detail-name {
  font-family: 'Syne', sans-serif;
  font-size: 1.15rem;
  font-weight: 800;
  color: var(--accent);
  margin-bottom: 6px;
}

.order-detail-chips {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.order-detail-section {
  background: var(--card);
  border-radius: 10px;
  padding: 14px 16px;
  margin-bottom: 12px;
}

.order-detail-section-title {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--muted);
  margin-bottom: 10px;
}

.order-detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.85rem;
  padding: 4px 0;
  border-bottom: 1px solid var(--border);
}
.order-detail-row:last-child { border-bottom: none; }
.order-detail-row .odr-label { color: var(--muted); font-size: 0.78rem; }
.order-detail-row .odr-value { font-weight: 600; }

.order-notes-area {
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.88rem;
  color: var(--text);
  background: var(--bg);
  resize: vertical;
  min-height: 80px;
  outline: none;
  transition: border-color 0.18s;
  -webkit-appearance: none;
}
.order-notes-area:focus { border-color: var(--accent); }

/* Status change inside detail modal */
.status-select-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.status-option-btn {
  flex: 1;
  min-width: 100px;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: var(--bg);
  cursor: pointer;
  font-size: 0.74rem;
  font-weight: 600;
  font-family: 'Outfit', sans-serif;
  text-align: center;
  transition: all 0.15s;
  color: var(--muted);
}
.status-option-btn.active-status { color: white; }
.status-option-btn[data-s="nowe"].active-status        { background: #1565c0; border-color: #1565c0; }
.status-option-btn[data-s="w-produkcji"].active-status { background: #e65100; border-color: #e65100; }
.status-option-btn[data-s="tartanowanie"].active-status{ background: #6a1b9a; border-color: #6a1b9a; }
.status-option-btn[data-s="zakonczone"].active-status  { background: #1b5e20; border-color: #1b5e20; }
.status-option-btn:hover:not(.active-status) { border-color: var(--text2); color: var(--text); }

/* Plywood dimensions in catalog */
.plywood-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
}
.plywood-item label {
  font-size: 0.68rem !important;
  color: var(--muted) !important;
  margin-bottom: 3px;
}
.plywood-dim-row {
  display: flex;
  gap: 4px;
  align-items: center;
}
.plywood-dim-row input {
  flex: 1;
  font-size: 0.82rem !important;
  padding: 8px 10px !important;
  text-align: center;
}
.plywood-dim-sep {
  font-size: 0.75rem;
  color: var(--muted);
  font-weight: 600;
}


/* ===================== POS BUTTON (header) ===================== */
.btn-pos {
  background: linear-gradient(135deg, #c47c1a, #e8960f);
  color: white;
  border: none;
  border-radius: 9px;
  padding: 7px 14px;
  font-family: 'Syne', sans-serif;
  font-size: 0.82rem;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  letter-spacing: 0.3px;
  box-shadow: 0 2px 8px rgba(196,124,26,0.35);
  transition: all 0.18s;
  white-space: nowrap;
}
.btn-pos:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(196,124,26,0.45); }
.btn-pos:active { transform: translateY(0); }

/* ===================== POS MODAL ===================== */
#modal-pos .modal {
  max-width: 700px;
  max-height: 92vh;
}

/* POS layout: left = products, right = basket + client */
.pos-layout {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 0;
  min-height: 500px;
  max-height: calc(92vh - 120px);
}

@media (max-width: 767px) {
  .pos-layout { grid-template-columns: 1fr; max-height: none; }
  #modal-pos .modal { max-width: 100%; }
}

.pos-products {
  padding: 16px;
  overflow-y: auto;
  border-right: 1px solid var(--border);
}

.pos-right {
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.pos-basket {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.pos-client {
  padding: 14px 16px;
  background: var(--card);
  flex-shrink: 0;
}

/* Product search */
.pos-search {
  position: relative;
  margin-bottom: 12px;
}
.pos-search input {
  width: 100%;
  padding: 9px 14px;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.88rem;
  background: var(--surface);
  outline: none;
  color: var(--text);
  -webkit-appearance: none;
}
.pos-search input:focus { border-color: var(--accent); }

/* Product grid */
.pos-product-grid {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.pos-product-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 9px;
  cursor: pointer;
  transition: all 0.15s;
  gap: 10px;
}
.pos-product-row:hover { border-color: var(--accent-mid); background: var(--accent-bg); }
.pos-product-row.out-of-stock { opacity: 0.5; }

.pos-product-info { flex: 1; min-width: 0; }
.pos-product-name { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pos-product-sku  { font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; color: var(--accent-mid); }
.pos-product-stock { font-size: 0.72rem; font-family: 'JetBrains Mono', monospace; color: var(--muted); white-space: nowrap; }

.pos-add-btn {
  width: 28px; height: 28px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 7px;
  font-size: 1.1rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  transition: background 0.15s;
}
.pos-add-btn:hover { background: var(--accent-light); }

/* Basket */
.pos-basket-title {
  font-family: 'Syne', sans-serif;
  font-size: 0.82rem;
  font-weight: 700;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.pos-basket-empty {
  text-align: center;
  padding: 24px 0;
  color: var(--muted);
  font-size: 0.82rem;
}

.pos-basket-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.pos-basket-item:last-child { border-bottom: none; }

.pos-basket-item-info { flex: 1; min-width: 0; }
.pos-basket-item-name { font-size: 0.82rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pos-basket-item-sku { font-size: 0.65rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
.pos-basket-item-tartan { font-size: 0.65rem; font-weight: 600; margin-top: 2px; }

.pos-qty-ctrl {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
}
.pos-qty-ctrl button {
  width: 24px; height: 24px;
  border: 1px solid var(--border2);
  background: var(--surface);
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
  display: flex; align-items: center; justify-content: center;
  color: var(--text2);
  transition: background 0.1s;
}
.pos-qty-ctrl button:hover { background: var(--card); }
.pos-qty-ctrl span {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  font-weight: 600;
  min-width: 20px;
  text-align: center;
}

.pos-remove-btn {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.9rem;
  padding: 2px 4px;
  border-radius: 4px;
  transition: color 0.1s;
  flex-shrink: 0;
}
.pos-remove-btn:hover { color: var(--red); }

/* Tartan dots in basket */
.pos-tartan-dots {
  display: flex;
  gap: 5px;
  margin-top: 4px;
  flex-wrap: wrap;
}
.pos-tartan-dot {
  width: 18px; height: 18px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.1s;
  flex-shrink: 0;
}
.pos-tartan-dot:hover { transform: scale(1.15); }
.pos-tartan-dot.selected { border-color: var(--text); transform: scale(1.15); }

/* Client section toggle */
.pos-client-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 8px 0;
  user-select: none;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text2);
}
.pos-client-toggle-check {
  width: 18px; height: 18px;
  border-radius: 5px;
  border: 2px solid var(--border2);
  background: var(--surface);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem;
  color: white;
  transition: all 0.15s;
  flex-shrink: 0;
}
.pos-client-toggle-check.on { background: var(--accent-mid); border-color: var(--accent-mid); }
.pos-client-fields { display: none; margin-top: 10px; }
.pos-client-fields.visible { display: block; }

.pos-client-fields .form-group { margin-bottom: 8px; }
.pos-client-fields .form-group:last-child { margin-bottom: 0; }
.pos-client-fields label {
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--muted);
  display: block;
  margin-bottom: 3px;
}
.pos-client-fields input {
  width: 100%;
  padding: 8px 12px;
  border: 1.5px solid var(--border);
  border-radius: 7px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.82rem;
  background: var(--surface);
  color: var(--text);
  outline: none;
  -webkit-appearance: none;
}
.pos-client-fields input:focus { border-color: var(--accent); }

/* Prio in pos basket */
.pos-prio-select {
  display: flex;
  gap: 4px;
  margin-top: 4px;
}
.pos-prio-btn {
  flex: 1;
  padding: 3px 6px;
  border-radius: 5px;
  border: 1px solid var(--border);
  background: var(--bg);
  font-size: 0.65rem;
  font-weight: 600;
  cursor: pointer;
  color: var(--muted);
  text-align: center;
  transition: all 0.12s;
  font-family: 'Outfit', sans-serif;
}
.pos-prio-btn.sel-1 { background: var(--red-bg); border-color: var(--red); color: var(--red); }
.pos-prio-btn.sel-2 { background: var(--amber-bg); border-color: var(--amber); color: var(--amber); }
.pos-prio-btn.sel-3 { background: var(--accent-bg); border-color: var(--accent-mid); color: var(--accent-mid); }

/* POS Orders list view */
.pos-order-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  margin-bottom: 10px;
  box-shadow: var(--shadow);
}
.pos-order-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
  gap: 10px;
}
.pos-order-client-name {
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--accent);
}
.pos-order-meta { font-size: 0.72rem; color: var(--muted); }
.pos-order-items { display: flex; flex-direction: column; gap: 4px; }
.pos-order-item-row {
  font-size: 0.82rem;
  display: flex;
  gap: 8px;
  align-items: center;
  color: var(--text2);
}


/* ===================== LOADING OVERLAY ===================== */
#loading-overlay {
  position: fixed;
  inset: 0;
  background: var(--accent);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  gap: 16px;
  transition: opacity 0.4s ease;
}
#loading-overlay.hidden { opacity: 0; pointer-events: none; }

.loading-logo {
  font-family: 'Syne', sans-serif;
  font-size: 2.4rem;
  font-weight: 800;
  color: white;
  letter-spacing: -1px;
}
.loading-logo span { color: #8fcf5a; }

.loading-spinner {
  width: 36px; height: 36px;
  border: 3px solid rgba(255,255,255,0.2);
  border-top-color: #8fcf5a;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: rgba(255,255,255,0.55); font-size: 0.82rem; letter-spacing: 1px; }
.sync-indicator {
  position: fixed;
  top: 70px; right: 12px;
  background: var(--accent);
  color: white;
  font-size: 0.72rem;
  padding: 4px 10px;
  border-radius: 20px;
  z-index: 500;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  font-family: 'JetBrains Mono', monospace;
}
.sync-indicator.visible { opacity: 1; }


/* ===================== STATUS TIMELINE ===================== */
.timeline {
  position: relative;
  padding: 4px 0 0 0;
}
.timeline-item {
  display: flex;
  gap: 12px;
  padding-bottom: 16px;
  position: relative;
}
.timeline-item:last-child { padding-bottom: 0; }
.timeline-left {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex-shrink: 0;
  width: 28px;
}
.timeline-dot {
  width: 28px; height: 28px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.85rem;
  flex-shrink: 0;
  border: 2px solid white;
  box-shadow: 0 1px 4px rgba(0,0,0,0.12);
  z-index: 1;
}
.timeline-line {
  width: 2px;
  flex: 1;
  background: var(--border);
  margin-top: 4px;
  min-height: 12px;
}
.timeline-content { flex: 1; padding-top: 3px; }
.timeline-label { font-weight: 700; font-size: 0.82rem; color: var(--text); }
.timeline-time  { font-size: 0.68rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-top: 1px; }
.timeline-by    { font-size: 0.68rem; color: var(--muted); }

/* ===================== KALKULATOR MATERIAŁOWY ===================== */
.calc-view { }
.calc-summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.calc-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  box-shadow: var(--shadow);
}
.calc-card-sku {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  font-weight: 700;
  color: var(--accent-mid);
  margin-bottom: 4px;
}
.calc-card-name {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 10px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.calc-card-qty {
  font-family: 'Syne', sans-serif;
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--accent);
  line-height: 1;
  margin-bottom: 2px;
}
.calc-card-unit { font-size: 0.72rem; color: var(--muted); }
.calc-card-dims {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
  font-size: 0.72rem;
  color: var(--text2);
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.calc-dim-row { display: flex; justify-content: space-between; }
.calc-dim-label { color: var(--muted); }
.calc-no-dims { font-size: 0.72rem; color: var(--muted); margin-top: 8px; font-style: italic; }
.calc-sheet-info {
  background: var(--accent-bg);
  border: 1.5px solid rgba(45,90,24,0.2);
  border-radius: 10px;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.85rem;
  color: var(--accent);
  font-weight: 600;
  margin-bottom: 6px;
}
.calc-sheet-number {
  font-family: 'Syne', sans-serif;
  font-size: 2rem;
  font-weight: 800;
  color: var(--accent);
  flex-shrink: 0;
}
.calc-empty { text-align: center; padding: 40px 0; color: var(--muted); }
.calc-settings {
  background: var(--card);
  border-radius: 10px;
  padding: 12px 16px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 0.82rem;
}
.calc-settings label { color: var(--muted); font-size: 0.75rem; font-weight: 600; }
.calc-settings input {
  width: 80px;
  padding: 6px 10px;
  border: 1.5px solid var(--border);
  border-radius: 7px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  background: var(--surface);
  color: var(--text);
  outline: none;
  -webkit-appearance: none;
}
.calc-settings input:focus { border-color: var(--accent); }

/* ===================== POS PDF BUTTON ===================== */
.btn-pdf {
  background: var(--red);
  color: white;
  border: none;
  border-radius: 7px;
  padding: 5px 12px;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  transition: all 0.15s;
}
.btn-pdf:hover { filter: brightness(0.9); }


/* ===================== OFFLINE BANNER ===================== */
#offline-banner {
  position: fixed;
  top: 0; left: 0; right: 0;
  background: var(--amber);
  color: white;
  text-align: center;
  padding: 8px 16px;
  font-size: 0.82rem;
  font-weight: 600;
  z-index: 9999;
  display: none;
  animation: slideDown 0.3s ease;
}
#offline-banner.visible { display: block; }
@keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

/* ===================== NOTIFICATION PERMISSION BAR ===================== */
#notif-permission-bar {
  background: linear-gradient(135deg, #1e3d0f, #2d5a18);
  color: white;
  padding: 10px 16px;
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  font-size: 0.82rem;
  flex-shrink: 0;
}
#notif-permission-bar.visible { display: flex; }
#notif-permission-bar .notif-bar-text { flex: 1; }
.btn-allow-notif {
  background: #8fcf5a;
  color: #1e3d0f;
  border: none;
  border-radius: 7px;
  padding: 6px 14px;
  font-weight: 700;
  font-size: 0.78rem;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  white-space: nowrap;
  flex-shrink: 0;
}
.btn-dismiss-notif {
  background: none;
  border: none;
  color: rgba(255,255,255,0.5);
  cursor: pointer;
  font-size: 1rem;
  padding: 0 4px;
  flex-shrink: 0;
}

/* ===================== STATS VIEW ===================== */
.stats-view {}
.stats-toolbar {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 20px;
  padding: 12px 16px;
  background: var(--card);
  border-radius: 12px;
}
.stats-toolbar label { font-size: 0.72rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
.stats-toolbar input[type="date"] {
  padding: 6px 10px;
  border: 1.5px solid var(--border);
  border-radius: 7px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.82rem;
  background: var(--surface);
  color: var(--text);
  outline: none;
  -webkit-appearance: none;
}
.stats-toolbar input[type="date"]:focus { border-color: var(--accent); }
.stats-range-sep { color: var(--muted); font-size: 0.8rem; }

.stats-kpi-row {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.stats-kpi {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  box-shadow: var(--shadow);
}
.stats-kpi-value {
  font-family: 'Syne', sans-serif;
  font-size: 2.2rem;
  font-weight: 800;
  color: var(--accent);
  line-height: 1;
}
.stats-kpi-label { font-size: 0.72rem; color: var(--muted); margin-top: 4px; }
.stats-kpi-sub { font-size: 0.68rem; color: var(--accent-mid); margin-top: 2px; font-weight: 600; }

.stats-section { margin-bottom: 24px; }
.stats-section-title {
  font-family: 'Syne', sans-serif;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Bar chart */
.bar-chart { display: flex; flex-direction: column; gap: 8px; }
.bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
}
.bar-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  color: var(--text2);
  min-width: 100px;
  flex-shrink: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.bar-track {
  flex: 1;
  height: 28px;
  background: var(--card);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}
.bar-fill {
  height: 100%;
  border-radius: 6px;
  background: linear-gradient(90deg, var(--accent-mid), var(--accent-light));
  transition: width 0.6s cubic-bezier(0.34,1.56,0.64,1);
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 8px;
  min-width: 32px;
}
.bar-fill-tartan { background: linear-gradient(90deg, #6a1b9a, #9c27b0); }
.bar-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  font-weight: 700;
  color: white;
}

/* Production time chart */
.time-chart { display: flex; flex-direction: column; gap: 6px; }
.time-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--card);
  border-radius: 8px;
}
.time-sku { font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; color: var(--accent-mid); min-width: 90px; flex-shrink: 0; }
.time-name { font-size: 0.78rem; flex: 1; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.time-duration {
  font-family: 'Syne', sans-serif;
  font-size: 0.88rem;
  font-weight: 700;
  color: var(--text);
  white-space: nowrap;
  flex-shrink: 0;
}
.time-count { font-size: 0.68rem; color: var(--muted); flex-shrink: 0; }
.stats-empty { text-align: center; padding: 32px; color: var(--muted); font-size: 0.85rem; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>

<div id="offline-banner">📶 Brak połączenia — aplikacja działa w trybie offline. Zmiany zostaną zsynchronizowane po przywróceniu internetu.</div>
<div id="notif-permission-bar">
  <span class="notif-bar-text">🔔 Włącz powiadomienia push — dostaniesz alert gdy pojawi się zlecenie DO TARTANOWANIA lub stan magazynu będzie niski</span>
  <button class="btn-allow-notif" onclick="requestNotifPermission()">Włącz powiadomienia</button>
  <button class="btn-dismiss-notif" onclick="dismissNotifBar()">✕</button>
</div>
<div id="loading-overlay">
  <div class="loading-logo">Set<span>Groom</span></div>
  <div class="loading-spinner"></div>
  <div class="loading-text">Łączenie z bazą danych...</div>
</div>
<div class="sync-indicator" id="sync-indicator">⟳ synchronizacja...</div>

<!-- ==================== LOGIN SCREEN ==================== -->
<div id="login-screen" style="display:none">
  <div class="login-logo">Set<span>Groom</span></div>
  <div class="login-sub">System zarządzania produkcją</div>
  <div class="login-label">Wybierz swoje stanowisko</div>
  <div class="login-cards">
    <div class="login-card" onclick="login('biuro')">
      <div class="login-card-icon">💼</div>
      <div class="login-card-name">Biuro</div>
      <div class="login-card-desc">Przyjmowanie zamówień, katalog produktów, magazyn</div>
    </div>
    <div class="login-card" onclick="login('produkcja')">
      <div class="login-card-icon">🔨</div>
      <div class="login-card-name">Produkcja</div>
      <div class="login-card-desc">Kolejka produkcyjna, oznaczanie ukończonych zleceń</div>
    </div>
  </div>
</div>

<!-- ==================== APP SHELL ==================== -->
<div id="app-shell">

  <header>
    <div class="logo">Set<span>Groom</span></div>

    <!-- Desktop nav -->
    <nav class="desktop-nav" id="desktop-nav">
      <button class="nav-tab active" onclick="switchView('orders')" id="tab-orders" data-role="biuro">
        📦 Zamówienia
      </button>
      <button class="nav-tab" onclick="switchView('queue')" id="tab-queue">
        ⚙ Kolejka <span class="nav-badge" id="queue-count-nav">0</span>
      </button>
      <button class="nav-tab" onclick="switchView('catalog')" id="tab-catalog" data-role="biuro">
        📋 Katalog
      </button>
      <button class="nav-tab" onclick="switchView('stock')" id="tab-stock" data-role="biuro">
        🏭 Magazyn
      </button>
      <button class="nav-tab" onclick="switchView('pos-orders')" id="tab-pos-orders">
        🛒 Zamówienia POS
      </button>
      <button class="nav-tab" onclick="switchView('calc')" id="tab-calc">
        📐 Kalkulator
      </button>
      <button class="nav-tab" onclick="switchView('stats')" id="tab-stats">
        📊 Statystyki
      </button>
    </nav>

    <div class="header-right">
      <button class="btn-pos" onclick="openPOS()">🛒 <span class="btn-pos-text">POS</span></button>
      <div class="user-pill">
        <span class="user-pill-icon" id="user-icon">💼</span>
        <span id="user-name-header">Biuro</span>
      </div>
      <span class="refresh-dot" title="Dane synchronizowane"></span>
      <button class="btn-logout" onclick="logout()">⏻ <span class="btn-logout-text">Wyloguj</span></button>
    </div>
  </header>

  <div class="main-scroll" id="main-scroll">

    <!-- ===== ZAMÓWIENIA ===== -->
    <div class="view active" id="view-orders">
      <div class="page-header">
        <div>
          <div class="page-title">Nowe zamówienie</div>
          <div class="page-subtitle">Sprawdź stan i dodaj do kolejki produkcyjnej</div>
        </div>
      </div>

      <div class="stats-row" id="stats-row">
        <div class="stat-card stat-clickable" onclick="switchView('catalog')" title="Przejdź do katalogu">
          <div class="stat-label">Produkty</div>
          <div class="stat-value" id="stat-products">0</div>
          <div class="stat-sub">w katalogu →</div>
        </div>
        <div class="stat-card stat-clickable" onclick="switchView('stock')" title="Przejdź do magazynu">
          <div class="stat-label">Na stanie</div>
          <div class="stat-value" id="stat-instock">0</div>
          <div class="stat-sub">gotowe →</div>
        </div>
        <div class="stat-card warn stat-clickable" onclick="switchView('queue')" title="Przejdź do kolejki">
          <div class="stat-label">Kolejka</div>
          <div class="stat-value" id="stat-queue">0</div>
          <div class="stat-sub">do produkcji →</div>
        </div>
        <div class="stat-card danger stat-clickable" onclick="switchView('stock')" title="Przejdź do magazynu">
          <div class="stat-label">Brak towaru</div>
          <div class="stat-value" id="stat-outofstock">0</div>
          <div class="stat-sub">produktów →</div>
        </div>
      </div>

      <div class="order-desktop-grid">
        <div class="order-form-card">
          <div class="panel-title">📦 Wprowadź zamówienie</div>

          <div class="form-group">
            <label>SKU produktu</label>
            <div class="sku-input-wrap">
              <input type="text" id="order-sku" placeholder="Wpisz SKU lub nazwę..." autocomplete="off"
                oninput="skuAutocomplete(this.value)" onkeydown="skuKeydown(event)" onblur="setTimeout(closeSkuDropdown,200)">
              <div class="sku-dropdown" id="sku-dropdown" style="display:none"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Ilość</label>
              <div class="qty-control">
                <button onclick="changeQty('order-qty',-1)">−</button>
                <input type="number" id="order-qty" value="1" min="1">
                <button onclick="changeQty('order-qty',1)">+</button>
              </div>
            </div>
            <div class="form-group">
              <label>Termin (opcjonalnie)</label>
              <input type="date" id="order-deadline">
            </div>
          </div>


          <div class="form-group" id="tartan-group" style="display:none">
            <div class="tartan-colors tartan-colors-auto">
              <div class="tartan-colors-label">🏴 Podest z tartanem — wybierz kolor:</div>
              <div class="tartan-dots">
                <div class="tartan-dot" data-color="Różowy" data-hex="#e91e8c" style="background:#e91e8c" onclick="selectTartan(this)" title="Różowy"></div>
                <div class="tartan-dot" data-color="Niebieski" data-hex="#1565c0" style="background:#1565c0" onclick="selectTartan(this)" title="Niebieski"></div>
                <div class="tartan-dot" data-color="Pomarańczowy" data-hex="#e65100" style="background:#e65100" onclick="selectTartan(this)" title="Pomarańczowy"></div>
                <div class="tartan-dot" data-color="Fioletowy" data-hex="#6a1b9a" style="background:#6a1b9a" onclick="selectTartan(this)" title="Fioletowy"></div>
                <div class="tartan-dot" data-color="Czerwony" data-hex="#c62828" style="background:#c62828" onclick="selectTartan(this)" title="Czerwony"></div>
              </div>
              <div class="tartan-selected-name" id="tartan-selected-name"></div>
            </div>
          </div>

          <div class="form-group">
            <label>Priorytet</label>
            <div class="prio-select" id="prio-select">
              <div class="prio-opt" data-p="1" onclick="selectPrio(1)">🔴 Wysoki</div>
              <div class="prio-opt selected" data-p="2" onclick="selectPrio(2)">🟡 Normalny</div>
              <div class="prio-opt" data-p="3" onclick="selectPrio(3)">🟢 Niski</div>
            </div>
          </div>

          <button class="btn btn-primary btn-full" onclick="processOrder()">
            ✓ Realizuj zamówienie
          </button>

          <div id="order-result"></div>
        </div>

        <div class="order-form-card">
          <div class="panel-title">📌 Ostatnie zamówienia</div>
          <div id="recent-orders">
            <div class="empty">
              <div class="empty-icon">📋</div>
              <div class="empty-title">Brak historii</div>
              <div class="empty-sub">Tutaj pojawią się ostatnie zamówienia</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== KOLEJKA ===== -->
    <div class="view" id="view-queue">
      <div class="page-header">
        <div>
          <div class="page-title">Kolejka produkcyjna</div>
          <div class="page-subtitle">Zlecenia do wyprodukowania</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="clearDoneQueue()">🗑 Usuń ukończone</button>
      </div>
      <div class="queue-filter-bar" id="queue-filter-bar">
        <button class="filter-btn active" data-filter="wszystkie" onclick="setQueueFilter('wszystkie')">
          Wszystkie <span class="filter-count" id="fc-wszystkie">0</span>
        </button>
        <button class="filter-btn" data-filter="nowe" onclick="setQueueFilter('nowe')">
          🆕 Nowe <span class="filter-count" id="fc-nowe">0</span>
        </button>
        <button class="filter-btn" data-filter="w-produkcji" onclick="setQueueFilter('w-produkcji')">
          ⚙ W produkcji <span class="filter-count" id="fc-w-produkcji">0</span>
        </button>
        <button class="filter-btn" data-filter="tartanowanie" onclick="setQueueFilter('tartanowanie')">
          🏴 Do tartanowania <span class="filter-count" id="fc-tartanowanie">0</span>
        </button>
        <button class="filter-btn" data-filter="zakonczone" onclick="setQueueFilter('zakonczone')">
          ✅ Zakończone <span class="filter-count" id="fc-zakonczone">0</span>
        </button>
      </div>
      <div id="queue-container"></div>
    </div>

    <!-- ===== KATALOG ===== -->
    <div class="view" id="view-catalog">
      <div class="page-header">
        <div>
          <div class="page-title">Katalog produktów</div>
          <div class="page-subtitle">Zarządzaj produktami i SKU</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openAddProduct()">+ Dodaj produkt</button>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="Szukaj po nazwie lub SKU..." oninput="filterCatalog(this.value)">
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Nazwa produktu</th>
              <th>Opis</th>
              <th>Cena</th>
              <th>Stan</th>
              <th>Min.</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="catalog-body"></tbody>
        </table>
      </div>
    </div>

    <!-- ===== MAGAZYN ===== -->
    <div class="view" id="view-stock">
      <div class="page-header">
        <div>
          <div class="page-title">Magazyn</div>
          <div class="page-subtitle">Aktualizuj stany po produkcji lub dostawie</div>
        </div>
      </div>

      <div class="section-title" style="margin-bottom:12px">Alerty stanów</div>
      <div id="stock-alerts" style="margin-bottom:24px"></div>

      <div class="section-title">Wszystkie produkty</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Nazwa</th>
              <th>Stan</th>
              <th>Min.</th>
              <th>Aktualizuj</th>
            </tr>
          </thead>
          <tbody id="stock-body"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /main-scroll -->

  <!-- Bottom nav (mobile) -->
  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="bnav-item active" onclick="switchView('orders')" id="bnav-orders">
        <div class="bnav-icon">📦</div>
        <div class="bnav-label">Zamówienia</div>
      </button>
      <button class="bnav-item" onclick="switchView('queue')" id="bnav-queue">
        <div class="bnav-icon">⚙<span class="bnav-badge" id="queue-count-bnav" style="display:none">0</span></div>
        <div class="bnav-label">Kolejka</div>
      </button>
      <button class="bnav-item" onclick="switchView('catalog')" id="bnav-catalog">
        <div class="bnav-icon">📋</div>
        <div class="bnav-label">Katalog</div>
      </button>
      <button class="bnav-item" onclick="switchView('stock')" id="bnav-stock">
        <div class="bnav-icon">🏭</div>
        <div class="bnav-label">Magazyn</div>
      </button>
      <button class="bnav-item" onclick="switchView('pos-orders')" id="bnav-pos-orders">
        <div class="bnav-icon">🛒</div>
        <div class="bnav-label">POS</div>
      </button>
      <button class="bnav-item" onclick="switchView('calc')" id="bnav-calc">
        <div class="bnav-icon">📐</div>
        <div class="bnav-label">Kalkulator</div>
      </button>
      <button class="bnav-item" onclick="switchView('stats')" id="bnav-stats">
        <div class="bnav-icon">📊</div>
        <div class="bnav-label">Statystyki</div>
      </button>
    </div>
  </nav>


    <!-- ===== POS ZAMÓWIENIA ===== -->
    <div class="view" id="view-pos-orders">
      <div class="page-header">
        <div>
          <div class="page-title">Zamówienia POS</div>
          <div class="page-subtitle">Zamówienia z targów i sprzedaży bezpośredniej</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openPOS()">+ Nowe zamówienie POS</button>
      </div>
      <div id="pos-orders-container"></div>
    </div>

    <!-- ===== KALKULATOR MATERIAŁOWY ===== -->
    <div class="view" id="view-calc">
      <div class="page-header">
        <div>
          <div class="page-title">Kalkulator materiałowy</div>
          <div class="page-subtitle">Ile sklejki potrzeba na aktywne zlecenia</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="renderCalc()">↻ Przelicz</button>
      </div>
      <div class="calc-settings">
        <span style="font-weight:600;color:var(--text)">Arkusz sklejki:</span>
        <div style="display:flex;align-items:center;gap:6px">
          <label>Szerokość (cm)</label>
          <input type="number" id="sheet-w" value="122" min="1">
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          <label>Długość (cm)</label>
          <input type="number" id="sheet-l" value="244" min="1">
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          <label>Zapas (%)</label>
          <input type="number" id="sheet-margin" value="10" min="0" max="50">
        </div>
      </div>
      <div id="calc-container"></div>
    </div>

    <!-- ===== STATYSTYKI ===== -->
    <div class="view" id="view-stats">
      <div class="page-header">
        <div>
          <div class="page-title">Statystyki</div>
          <div class="page-subtitle">Analiza produkcji w wybranym okresie</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="renderStatsView()">↻ Przelicz</button>
      </div>
      <div class="stats-toolbar">
        <label>Od</label>
        <input type="date" id="stats-from">
        <span class="stats-range-sep">—</span>
        <label>Do</label>
        <input type="date" id="stats-to">
        <button class="btn btn-primary btn-sm" onclick="renderStatsView()" style="margin-left:4px">Pokaż</button>
        <button class="btn btn-secondary btn-sm" onclick="statsPreset('week')">7 dni</button>
        <button class="btn btn-secondary btn-sm" onclick="statsPreset('month')">30 dni</button>
        <button class="btn btn-secondary btn-sm" onclick="statsPreset('all')">Wszystko</button>
      </div>
      <div id="stats-container"></div>
    </div>

</div><!-- /app-shell -->


<!-- ==================== MODAL: POS ==================== -->
<div class="modal-overlay" id="modal-pos" style="display:none" onclick="if(event.target===this)closeModal('modal-pos')">
  <div class="modal" style="max-width:700px;border-radius:20px 20px 0 0;width:100%">
    <div class="modal-handle"></div>
    <div class="modal-header" style="padding-bottom:12px;border-bottom:1px solid var(--border)">
      <div class="modal-title">🛒 POS — Nowe zamówienie</div>
      <button class="modal-close" onclick="closeModal('modal-pos')">✕</button>
    </div>
    <div class="pos-layout">

      <!-- LEFT: product list -->
      <div class="pos-products">
        <div class="pos-search">
          <input type="text" id="pos-search" placeholder="Szukaj produktu po nazwie lub SKU..." oninput="renderPosProducts(this.value)" autocomplete="off">
        </div>
        <div class="pos-product-grid" id="pos-product-grid"></div>
      </div>

      <!-- RIGHT: basket + client -->
      <div class="pos-right">
        <div class="pos-basket">
          <div class="pos-basket-title">
            <span>Koszyk</span>
            <span id="pos-basket-count" style="font-size:0.72rem;color:var(--muted);font-weight:500"></span>
          </div>
          <div id="pos-basket-list">
            <div class="pos-basket-empty">Kliknij produkty aby dodać</div>
          </div>
        </div>

        <div class="pos-client">
          <div class="pos-client-toggle" onclick="togglePosClient()">
            <div class="pos-client-toggle-check" id="pos-client-check"></div>
            <span>Dane klienta (wysyłka)</span>
          </div>
          <div class="pos-client-fields" id="pos-client-fields">
            <div class="form-group"><label>Imię i nazwisko</label><input type="text" id="pos-name" placeholder="Jan Kowalski"></div>
            <div class="form-group"><label>Telefon</label><input type="tel" id="pos-phone" placeholder="+48 000 000 000"></div>
            <div class="form-group"><label>Email</label><input type="email" id="pos-email" placeholder="jan@email.com"></div>
            <div class="form-group"><label>Adres dostawy</label><input type="text" id="pos-address" placeholder="ul. Przykładowa 1, 00-000 Warszawa"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer" style="border-top:1px solid var(--border);padding-top:14px">
      <button class="btn btn-secondary" onclick="closeModal('modal-pos')">Anuluj</button>
      <button class="btn btn-primary" onclick="submitPosOrder()" style="background:linear-gradient(135deg,#c47c1a,#e8960f)">
        ✓ Zatwierdź zamówienie POS
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL: PRODUKT ==================== -->
<div class="modal-overlay" id="modal-product" style="display:none" onclick="if(event.target===this)closeModal('modal-product')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="modal-product-title">Dodaj produkt</div>
      <button class="modal-close" onclick="closeModal('modal-product')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>SKU *</label>
          <input type="text" id="p-sku" placeholder="POD-M-OAK-01" style="text-transform:uppercase">
        </div>
        <div class="form-group">
          <label>Cena (PLN)</label>
          <input type="number" id="p-price" placeholder="0.00" min="0" step="0.01">
        </div>
      </div>
      <div class="form-group">
        <label>Nazwa produktu *</label>
        <input type="text" id="p-name" placeholder="Podest dla psa M — Dąb naturalny">
      </div>
      <div class="form-group">
        <label>Opis (opcjonalnie)</label>
        <input type="text" id="p-desc" placeholder="np. materiał, kolor...">
      </div>
      <div class="form-group">
        <label>Wymiary sklejki (cm) — Szerokość × Długość</label>
        <div class="plywood-grid">
          <div class="plywood-item">
            <label>Element A</label>
            <div class="plywood-dim-row">
              <input type="number" id="p-a-w" placeholder="szer." min="0" step="0.1">
              <span class="plywood-dim-sep">×</span>
              <input type="number" id="p-a-l" placeholder="dł." min="0" step="0.1">
            </div>
          </div>
          <div class="plywood-item">
            <label>Element B</label>
            <div class="plywood-dim-row">
              <input type="number" id="p-b-w" placeholder="szer." min="0" step="0.1">
              <span class="plywood-dim-sep">×</span>
              <input type="number" id="p-b-l" placeholder="dł." min="0" step="0.1">
            </div>
          </div>
          <div class="plywood-item">
            <label>Wieko</label>
            <div class="plywood-dim-row">
              <input type="number" id="p-c-w" placeholder="szer." min="0" step="0.1">
              <span class="plywood-dim-sep">×</span>
              <input type="number" id="p-c-l" placeholder="dł." min="0" step="0.1">
            </div>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Stan magazynu</label>
          <input type="number" id="p-stock" value="0" min="0">
        </div>
        <div class="form-group">
          <label>Minimalny stan</label>
          <input type="number" id="p-min" value="2" min="0">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-product')">Anuluj</button>
      <button class="btn btn-primary" onclick="saveProduct()">Zapisz</button>
    </div>
  </div>
</div>


<!-- ==================== MODAL: ORDER DETAIL ==================== -->
<div class="modal-overlay" id="modal-order" style="display:none" onclick="if(event.target===this)closeModal('modal-order')">
  <div class="modal" style="max-width:540px">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">Szczegóły zlecenia</div>
      <button class="modal-close" onclick="closeModal('modal-order')">✕</button>
    </div>
    <div class="modal-body" id="modal-order-body">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-order')">Zamknij</button>
      <button class="btn btn-primary" onclick="saveOrderDetail()">💾 Zapisz notatki</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let products = [];
let queue = [];
let orderHistory = [];
let selectedPrio = 2;
let editingProductId = null;
let tartanActive = false;
let tartanColor = null;
let queueFilter = 'wszystkie';
let detailOrderId = null; // { color: "Różowy", hex: "#e91e8c" }
let currentUser = null; // 'biuro' | 'produkcja'
let syncInterval = null;
let catalogFilter = '';

// ============================================================
// STORAGE — Firebase Firestore (synchronizacja w czasie rzeczywistym)
// Dane wspólne dla wszystkich urządzeń i użytkowników
// ============================================================

let _unsubscribers = []; // Firestore listeners
let _isSaving = false;   // prevent echo updates
let _dbReady = false;

function showSyncIndicator() {
  const el = document.getElementById('sync-indicator');
  if (!el) return;
  el.classList.add('visible');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('visible'), 1500);
}

// Initialize Firestore listeners — called once after Firebase ready
function initFirestore() {
  const db = window._db;
  const docRef = window._doc;
  const onSnap = window._onSnapshot;
  if (!db) return;

  _dbReady = true;

  // Listen to 'data' document in 'setgroom' collection
  const dataRef = docRef(db, 'setgroom', 'data');
  const posRef  = docRef(db, 'setgroom', 'pos');

  const unsub1 = onSnap(dataRef, (snap) => {
    if (!snap.exists()) return;
    const d = snap.data();
    if (_isSaving) return; // skip our own writes echoing back
    let changed = false;
    if (d.products && JSON.stringify(d.products) !== JSON.stringify(products)) {
      products = d.products; changed = true;
    }
    if (d.queue && JSON.stringify(d.queue) !== JSON.stringify(queue)) {
      queue = d.queue; changed = true;
    }
    if (d.orderHistory && JSON.stringify(d.orderHistory) !== JSON.stringify(orderHistory)) {
      orderHistory = d.orderHistory; changed = true;
    }
    if (changed) { showSyncIndicator(); render(); checkTartanNotif(); checkLowStockNotif(); }
  });

  const unsub2 = onSnap(posRef, (snap) => {
    if (!snap.exists()) return;
    const d = snap.data();
    if (_isSaving) return;
    if (d.posOrders && JSON.stringify(d.posOrders) !== JSON.stringify(posOrders)) {
      posOrders = d.posOrders;
      showSyncIndicator();
      renderPosOrdersList();
    }
  });

  _unsubscribers = [unsub1, unsub2];
}

async function loadData() {
  // Wait for Firebase to be ready
  if (!window._firebaseReady) {
    await new Promise(resolve => window.addEventListener('firebase-ready', resolve, { once: true }));
  }

  const db = window._db;
  const docRef = window._doc;
  const getDocs = window._getDocs;

  // Load initial data from Firestore
  try {
    const snap = await docRef(db, 'setgroom', 'data').get?.() ||
      await (await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js")).getDoc(docRef(db, 'setgroom', 'data'));
    if (snap.exists()) {
      const d = snap.data();
      if (d.products)     products     = d.products;
      if (d.queue)        queue        = d.queue;
      if (d.orderHistory) orderHistory = d.orderHistory;
    }
  } catch(e) { console.warn('loadData error:', e); }

  try {
    const snap2 = await (await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js")).getDoc(docRef(db, 'setgroom', 'pos'));
    if (snap2.exists()) {
      const d = snap2.data();
      if (d.posOrders) posOrders = d.posOrders;
    }
  } catch(e) {}

  // Start real-time listeners
  initFirestore();

  render();
}

async function save() {
  if (!_dbReady || !window._db) return;
  checkLowStockNotif();
  checkTartanNotif();
  _isSaving = true;
  try {
    await window._setDoc(window._doc(window._db, 'setgroom', 'data'), {
      products,
      queue,
      orderHistory,
      updatedAt: new Date().toISOString(),
    });
  } catch(e) { console.error('save error:', e); }
  setTimeout(() => { _isSaving = false; }, 500);
}

// silentRefresh no longer needed — Firestore onSnapshot handles it
function silentRefresh() {}

// ============================================================
// LOGIN / LOGOUT
// ============================================================
function login(role) {
  currentUser = role;
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app-shell').style.display = 'flex';

  const isProdukcja = role === 'produkcja';
  document.getElementById('user-name-header').textContent = isProdukcja ? 'Produkcja' : 'Biuro';
  document.getElementById('user-icon').textContent = isProdukcja ? '🔨' : '💼';

  if (isProdukcja) switchView('queue');
  else switchView('orders');

  loadData();

  clearInterval(syncInterval); // Firestore onSnapshot handles real-time sync
  initNotifications();
}

function logout() {
  clearInterval(syncInterval);
  currentUser = null;
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app-shell').style.display = 'none';
}

// ============================================================
// NAVIGATION
// ============================================================
function switchView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.bnav-item').forEach(t => t.classList.remove('active'));

  document.getElementById('view-' + name).classList.add('active');
  const dt = document.getElementById('tab-' + name);
  if (dt) dt.classList.add('active');
  const bn = document.getElementById('bnav-' + name);
  if (bn) bn.classList.add('active');

  document.getElementById('main-scroll').scrollTop = 0;
  render();
}

// ============================================================
// RENDER
// ============================================================
function render() {
  renderStats();
  renderCatalog(catalogFilter);
  renderQueue();
  renderStock();
  renderRecentOrders();
  renderPosOrdersList();
}

function renderStats() {
  const total = products.length;
  const inStock = products.filter(p => p.stock > 0).length;
  const queueCount = queue.filter(q => !q.done).length;
  const outOf = products.filter(p => p.stock === 0).length;

  setEl('stat-products', total);
  setEl('stat-instock', inStock);
  setEl('stat-queue', queueCount);
  setEl('stat-outofstock', outOf);
  setEl('queue-count-nav', queueCount);

  const bnav = document.getElementById('queue-count-bnav');
  if (bnav) { bnav.textContent = queueCount; bnav.style.display = queueCount > 0 ? 'block' : 'none'; }
}

function setEl(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function renderCatalog(filter = '') {
  const body = document.getElementById('catalog-body');
  if (!body) return;
  const f = filter.toLowerCase();
  const list = f ? products.filter(p =>
    p.name.toLowerCase().includes(f) || p.sku.toLowerCase().includes(f)
  ) : products;

  if (list.length === 0) {
    body.innerHTML = `<tr><td colspan="7"><div class="empty">
      <div class="empty-icon">📦</div>
      <div class="empty-title">${filter ? 'Brak wyników' : 'Brak produktów'}</div>
      <div class="empty-sub">${filter ? 'Zmień wyszukiwanie' : 'Kliknij "+ Dodaj produkt"'}</div>
    </div></td></tr>`;
    return;
  }

  body.innerHTML = list.map(p => {
    const sc = p.stock === 0 ? 'stock-out' : p.stock <= p.minStock ? 'stock-low' : 'stock-ok';
    const si = p.stock === 0 ? '⊘' : p.stock <= p.minStock ? '⚠' : '✓';
    return `<tr>
      <td><span class="sku-badge">${p.sku}</span></td>
      <td><strong>${p.name}</strong></td>
      <td style="color:var(--muted);font-size:0.8rem">${p.desc || '—'}</td>
      <td style="font-size:0.85rem">${p.price ? p.price.toFixed(2)+' zł' : '—'}</td>
      <td><span class="stock-badge ${sc}">${si} ${p.stock} szt.</span></td>
      <td style="color:var(--muted);font-size:0.82rem">${p.minStock}</td>
      <td>
        <div style="display:flex;gap:5px">
          <button class="btn btn-secondary btn-sm" onclick="openEditProduct('${p.id}')">✏</button>
          <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')">🗑</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// Determine size group from SKU: XS, S, M, L, XL, XXL, then standard vs tartan
const SIZE_ORDER = ['XS','S','M','L','XL','XXL'];

function getSizeGroup(sku) {
  const upper = sku.toUpperCase();
  const isTartan = upper.includes('-T');
  // Match size prefix
  for (const size of ['XXL','XL','L','M','S','XS']) {
    if (upper.startsWith(size + '-') || upper === size) {
      return { size, isTartan, groupKey: size + (isTartan ? '-T' : '') };
    }
  }
  return { size: 'INNE', isTartan, groupKey: 'INNE' + (isTartan ? '-T' : '') };
}

function renderQueue() {
  const container = document.getElementById('queue-container');
  if (!container) return;
  const today = new Date(); today.setHours(0,0,0,0);

  updateFilterCounts();

  // Apply status filter
  const filterFn = (q) => {
    if (queueFilter === 'wszystkie') return true;
    if (queueFilter === 'zakonczone') return q.done;
    return !q.done && (q.status || 'nowe') === queueFilter;
  };

  const active = queue.filter(q => !q.done).filter(filterFn);
  const done   = queueFilter === 'wszystkie' || queueFilter === 'zakonczone'
    ? queue.filter(q => q.done)
    : [];

  if (active.length === 0 && done.length === 0) {
    container.innerHTML = `<div class="empty">
      <div class="empty-icon">✅</div>
      <div class="empty-title">Kolejka pusta</div>
      <div class="empty-sub">Wszystko wyprodukowane lub brak zleceń</div>
    </div>`;
    return;
  }

  // Group active items by size+type
  const groups = {};
  active.forEach(item => {
    const g = getSizeGroup(item.sku);
    if (!groups[g.groupKey]) groups[g.groupKey] = { ...g, items: [] };
    groups[g.groupKey].items.push(item);
  });

  // Sort groups: sizes in order, standard before tartan
  const sortedGroupKeys = Object.keys(groups).sort((a, b) => {
    const ga = groups[a], gb = groups[b];
    const ia = SIZE_ORDER.indexOf(ga.size);
    const ib = SIZE_ORDER.indexOf(gb.size);
    if (ia !== ib) return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
    return ga.isTartan ? 1 : -1;
  });

  let html = '';
  let globalIdx = 1;

  if (active.length > 0) {
    sortedGroupKeys.forEach(gKey => {
      const group = groups[gKey];
      const groupLabel = group.size + (group.isTartan ? ' — Tartan' : ' — Standard');
      const badgeClass = group.isTartan ? 'tartan' : 'standard';

      html += `<div class="size-group-header">
        <div class="size-group-title">${group.size}</div>
        <span class="size-group-badge">${group.isTartan ? 'TARTAN' : 'STANDARD'}</span>
        <span style="font-size:0.72rem;color:var(--muted);font-family:'JetBrains Mono',monospace">${group.items.length} szt.</span>
        <div class="size-group-line"></div>
      </div>`;

      html += `<div class="queue-list" style="margin-bottom:8px">`;
      group.items.forEach(item => {
        const posClass = item.priority === 1 ? 'high' : item.priority === 3 ? 'low' : '';
        const isUrgent = item.deadline && new Date(item.deadline) < new Date(today.getTime() + 2 * 86400000);
        const status = item.status || 'nowe';
        const statusDef = getStatusDef(status);
        const statusItemClass = 'status-' + status;

        html += `<div class="queue-item ${statusItemClass} queue-item-clickable" id="qi-${item.id}" onclick="openOrderDetail('${item.id}')">
          <div class="qi-top">
            <div class="queue-pos ${posClass}">${globalIdx++}</div>
            <div class="qi-name">${item.productName}</div>
            <div class="status-wrap">
              <button class="status-badge ${statusDef.cls}" onclick="event.stopPropagation();openStatusMenu('${item.id}', this)">
                ${statusDef.icon} ${statusDef.label} ▾
              </button>
            </div>
          </div>
          <div class="qi-meta">
            <span class="queue-chip">${item.sku}</span>
            <span class="queue-chip qty">📦 ${item.qty} szt.</span>
            ${item.deadline ? `<span class="queue-chip deadline${isUrgent?' urgent':''}">⏰ ${formatDate(item.deadline)}</span>` : ''}
            <span class="queue-chip">${['','🔴 Wysoki','🟡 Normalny','🟢 Niski'][item.priority]}</span>
            ${item.tartan ? `<span class="queue-chip tartan" style="background:${item.tartan.hex};color:white;font-weight:700">🏴 ${item.tartan.color}</span>` : ''}
            <span class="queue-chip" style="color:var(--muted)">${formatDateTime(item.addedAt)}</span>
          </div>
          <div class="qi-actions">
            <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();removeQueueItem('${item.id}')">🗑</button>
          </div>
        </div>`;
      });
      html += `</div>`;
    });
  }

  if (done.length > 0) {
    html += `<div class="size-group-header" style="margin-top:12px">
      <div class="size-group-title" style="color:var(--muted)">ZAKOŃCZONE</div>
      <span class="size-group-badge" style="background:var(--muted)">${done.length}</span>
      <div class="size-group-line"></div>
    </div>`;
    html += `<div class="queue-list">`;
    done.forEach(item => {
      html += `<div class="queue-item done queue-item-clickable" id="qi-${item.id}" onclick="openOrderDetail('${item.id}')">
        <div class="qi-top">
          <div class="queue-pos" style="background:var(--muted)">✓</div>
          <div class="qi-name" style="text-decoration:line-through">${item.productName}</div>
          <span class="status-badge status-zakonczone">✅ ZAKOŃCZONE</span>
        </div>
        <div class="qi-meta">
          <span class="queue-chip">${item.sku}</span>
          <span class="queue-chip qty">📦 ${item.qty} szt.</span>
          ${item.tartan ? `<span class="queue-chip tartan" style="background:${item.tartan.hex};color:white">🏴 ${item.tartan.color}</span>` : ''}
          ${item.doneAt ? `<span class="queue-chip">✓ ${formatDateTime(item.doneAt)}</span>` : ''}
        </div>
        <div class="qi-actions">
          <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();removeQueueItem('${item.id}')">🗑</button>
        </div>
      </div>`;
    });
    html += `</div>`;
  }

  container.innerHTML = html;
}

function renderStock() {
  const alerts = products.filter(p => p.stock <= p.minStock);
  const alertsDiv = document.getElementById('stock-alerts');
  if (alertsDiv) {
    if (alerts.length === 0) {
      alertsDiv.innerHTML = `<div style="color:var(--accent-mid);font-size:0.85rem;padding:10px 0">✅ Wszystkie stany magazynowe w normie.</div>`;
    } else {
      alertsDiv.innerHTML = `<div class="queue-list">${alerts.map(p => `
        <div class="queue-item" style="border-left:3px solid var(--${p.stock===0?'red':'amber'})">
          <div class="qi-top">
            <div class="queue-pos" style="background:var(--${p.stock===0?'red':'amber'})">${p.stock===0?'⊘':'!'}</div>
            <div class="qi-name">${p.name}</div>
          </div>
          <div class="qi-meta">
            <span class="queue-chip">${p.sku}</span>
            <span class="queue-chip" style="color:var(--${p.stock===0?'red':'amber'})">${p.stock===0?'BRAK TOWARU':'Niski stan: '+p.stock+' szt.'}</span>
            <span class="queue-chip">Min: ${p.minStock} szt.</span>
          </div>
        </div>`).join('')}</div>`;
    }
  }

  const body = document.getElementById('stock-body');
  if (!body) return;
  if (products.length === 0) {
    body.innerHTML = `<tr><td colspan="5"><div class="empty"><div class="empty-icon">📦</div><div class="empty-title">Brak produktów</div></div></td></tr>`;
    return;
  }

  body.innerHTML = products.map(p => {
    const sc = p.stock === 0 ? 'stock-out' : p.stock <= p.minStock ? 'stock-low' : 'stock-ok';
    const si = p.stock === 0 ? '⊘' : p.stock <= p.minStock ? '⚠' : '✓';
    return `<tr>
      <td><span class="sku-badge">${p.sku}</span></td>
      <td><strong style="font-size:0.85rem">${p.name}</strong></td>
      <td><span class="stock-badge ${sc}">${si} ${p.stock}</span></td>
      <td style="color:var(--muted);font-size:0.82rem">${p.minStock}</td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="qty-control">
            <button onclick="changeQty('sq-${p.id}',-1)">−</button>
            <input type="number" id="sq-${p.id}" value="${p.stock}" min="0">
            <button onclick="changeQty('sq-${p.id}',1)">+</button>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="updateStock('${p.id}')">💾</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function renderRecentOrders() {
  const div = document.getElementById('recent-orders');
  if (!div) return;

  if (orderHistory.length === 0) {
    div.innerHTML = `<div class="empty">
      <div class="empty-icon">📋</div>
      <div class="empty-title">Brak historii</div>
      <div class="empty-sub">Tutaj pojawią się ostatnie zamówienia</div>
    </div>`;
    return;
  }

  const recent = [...orderHistory].reverse().slice(0, 10);
  div.innerHTML = `<div class="recent-list">${recent.map(o => `
    <div class="recent-item">
      <div class="recent-item-top">
        <div class="recent-item-name">${o.productName}</div>
        <div class="recent-item-time">${formatDateTime(o.time)}</div>
      </div>
      <div class="recent-chips">
        <span class="queue-chip">${o.sku}</span>
        <span class="queue-chip qty">📦 ${o.qty} szt.</span>
        <span class="queue-chip">${o.action === 'stock' ? '✓ Z magazynu' : '⚙ Do produkcji'}</span>
        ${o.tartan ? `<span class="queue-chip tartan" style="background:${o.tartan.hex};color:white;font-weight:700">🏴 Tartan ${o.tartan.color}</span>` : ''}
        <span class="queue-chip">${o.by === 'biuro' ? '💼' : '🔨'} ${o.by === 'biuro' ? 'Biuro' : 'Produkcja'}</span>
      </div>
    </div>`).join('')}
  </div>`;
}

// ============================================================
// ORDER
// ============================================================
function processOrder() {
  const skuRaw = document.getElementById('order-sku').value.trim().toUpperCase();
  const qty = parseInt(document.getElementById('order-qty').value) || 1;
  const deadline = document.getElementById('order-deadline').value;
  const resultDiv = document.getElementById('order-result');

  // Walidacja tartanu — jeśli SKU zawiera -T, kolor musi być wybrany
  const skuForCheck = document.getElementById('order-sku').value.trim().toUpperCase();
  if (skuForCheck.includes('-T') && !tartanColor) {
    const nameEl = document.getElementById('tartan-selected-name');
    if (nameEl) { nameEl.textContent = '⚠ Wybierz kolor tartanu!'; nameEl.style.color = 'var(--red)'; }
    // Pulse animation on dots
    document.querySelectorAll('.tartan-dot').forEach(d => {
      d.style.animation = 'none';
      setTimeout(() => { d.style.animation = 'tartanPulse 0.4s ease 2'; }, 10);
    });
    return;
  }

  if (!skuRaw) {
    document.getElementById('order-sku').classList.add('error');
    setTimeout(() => document.getElementById('order-sku').classList.remove('error'), 2000);
    return;
  }

  const product = products.find(p => p.sku === skuRaw);
  const tartanInfo = tartanActive && tartanColor ? tartanColor : null;
  const tartanLabel = tartanInfo ? ` + Tartan ${tartanInfo.color}` : '';

  if (!product) {
    resultDiv.innerHTML = `<div class="order-result">
      <div class="order-result-title">⊘ Nieznane SKU</div>
      <p>Produkt <strong>${skuRaw}</strong> nie istnieje w katalogu.</p>
    </div>`;
    return;
  }

  if (product.stock >= qty) {
    product.stock -= qty;
    orderHistory.push({ id: uid(), sku: product.sku, productName: product.name, qty, time: new Date().toISOString(), action: 'stock', by: currentUser, tartan: tartanInfo });
    save();

    resultDiv.innerHTML = `<div class="order-result success">
      <div class="order-result-title">✅ Dostępne na stanie!</div>
      <p><strong>${product.name}${tartanLabel}</strong> (${qty} szt.) wydano z magazynu.<br>Pozostało: <strong>${product.stock} szt.</strong></p>
    </div>`;

    notify(`✓ Wydano ${qty} szt. z magazynu${tartanLabel}`);
    scheduleClearForm();
  } else {
    const neededQty = qty - product.stock;
    if (product.stock > 0) product.stock = 0;

    queue.push({
      id: uid(),
      sku: product.sku,
      productName: product.name,
      qty: neededQty,
      priority: selectedPrio,
      deadline: deadline || null,
      addedAt: new Date().toISOString(),
      addedBy: currentUser,
      tartan: tartanInfo,
      status: 'nowe',
      done: false,
      statusLog: [{ status: 'nowe', at: new Date().toISOString(), by: currentUser }]
    });

    orderHistory.push({ id: uid(), sku: product.sku, productName: product.name, qty, time: new Date().toISOString(), action: 'queue', by: currentUser, tartan: tartanInfo });
    save();

    resultDiv.innerHTML = `<div class="order-result added">
      <div class="order-result-title">⚙ Dodano do kolejki produkcyjnej</div>
      <p>Brak wystarczającego stanu.<br><strong>${neededQty} szt.${tartanLabel}</strong> dodano do kolejki.</p>
    </div>`;

    notify(`⚙ ${product.name}${tartanLabel} — ${neededQty} szt. w kolejce`, 'warn');
    scheduleClearForm();
  }

  render();
}

let clearFormTimer;
function scheduleClearForm() {
  clearTimeout(clearFormTimer);
  clearFormTimer = setTimeout(() => {
    document.getElementById('order-sku').value = '';
    document.getElementById('order-qty').value = 1;
    document.getElementById('order-deadline').value = '';
    document.getElementById('order-result').innerHTML = '';
    selectPrio(2);
    resetTartan();
  }, 4000);
}

// ============================================================
// QUEUE ACTIONS
// ============================================================
// STATUS DEFINITIONS
const STATUSES = [
  { key: 'nowe',          label: 'NOWE',          icon: '🆕', cls: 'status-nowe' },
  { key: 'w-produkcji',   label: 'W PRODUKCJI',   icon: '⚙',  cls: 'status-w-produkcji' },
  { key: 'tartanowanie',  label: 'DO TARTANOWANIA',icon: '🏴', cls: 'status-tartanowanie' },
  { key: 'zakonczone',    label: 'ZAKOŃCZONE',     icon: '✅', cls: 'status-zakonczone' },
];

function getStatusDef(key) {
  return STATUSES.find(s => s.key === key) || STATUSES[0];
}

function changeStatus(id, newStatus) {
  closeAllStatusMenus();
  const item = queue.find(q => q.id === id);
  if (!item) return;

  const oldStatus = item.status || 'nowe';

  // Special flow for tartan items
  if (newStatus === 'zakonczone') {
    if (item.tartan && oldStatus === 'w-produkcji') {
      // Tartan item in W PRODUKCJI → goes to DO TARTANOWANIA first
      item.status = 'tartanowanie';
      if (!item.statusLog) item.statusLog = [];
      item.statusLog.push({ status: 'tartanowanie', at: new Date().toISOString(), by: currentUser });
      save(); renderQueue(); renderStats();
      notify(`🏴 ${item.productName} — wymaga tartanowania!`, 'warn');
      return;
    }
    // Final completion: update stock
    item.status = 'zakonczone';
    item.done = true;
    item.doneAt = new Date().toISOString();
    item.doneBy = currentUser;
    if (!item.statusLog) item.statusLog = [];
    item.statusLog.push({ status: 'zakonczone', at: item.doneAt, by: currentUser });
    const product = products.find(p => p.sku === item.sku);
    if (product) product.stock += item.qty;
    save(); renderQueue(); renderStock(); renderStats();
    notify(`✅ ${item.productName} — zakończono! Magazyn: +${item.qty} szt.`);
    return;
  }

  item.status = newStatus;
  if (!item.statusLog) item.statusLog = [];
  item.statusLog.push({ status: newStatus, at: new Date().toISOString(), by: currentUser });
  save(); renderQueue(); renderStats();
  const def = getStatusDef(newStatus);
  notify(`${def.icon} ${item.productName} — ${def.label}`);
}

function openStatusMenu(id, el) {
  closeAllStatusMenus();
  const item = queue.find(q => q.id === id);
  if (!item) return;

  const currentStatus = item.status || 'nowe';
  const isTartan = !!item.tartan;

  let menuHtml = '';
  STATUSES.forEach(s => {
    // Hide tartanowanie option for non-tartan items
    if (s.key === 'tartanowanie' && !isTartan) return;
    const isActive = s.key === currentStatus;
    menuHtml += `<div class="status-menu-item ${isActive ? 'active' : ''}" onclick="changeStatus('${id}','${s.key}')">
      ${s.icon} ${s.label} ${isActive ? '✓' : ''}
    </div>`;
  });

  const menu = document.createElement('div');
  menu.className = 'status-menu';
  menu.id = 'smenu-' + id;
  menu.innerHTML = menuHtml;

  el.closest('.status-wrap').appendChild(menu);

  setTimeout(() => {
    document.addEventListener('click', closeAllStatusMenus, { once: true });
  }, 10);
}

function closeAllStatusMenus() {
  document.querySelectorAll('.status-menu').forEach(m => m.remove());
}

function markDone(id) {
  // Legacy — now handled by changeStatus
  changeStatus(id, 'zakonczone');
}

function removeQueueItem(id) {
  queue = queue.filter(q => q.id !== id);
  save();
  renderQueue();
  renderStats();
}

function clearDoneQueue() {
  const count = queue.filter(q => q.done).length;
  if (count === 0) { notify('Brak ukończonych pozycji'); return; }
  queue = queue.filter(q => !q.done);
  save();
  renderQueue();
  renderStats();
  notify(`🗑 Usunięto ${count} ukończone pozycje`);
}

// ============================================================
// STOCK
// ============================================================
function updateStock(productId) {
  const input = document.getElementById('sq-' + productId);
  const val = parseInt(input.value);
  if (isNaN(val) || val < 0) return;
  const p = products.find(p => p.id === productId);
  if (!p) return;
  p.stock = val;
  save();
  renderStock();
  renderStats();
  notify(`💾 Stan "${p.name}" zaktualizowany: ${val} szt.`);
}

// ============================================================
// CATALOG CRUD
// ============================================================
function openAddProduct() {
  editingProductId = null;
  document.getElementById('modal-product-title').textContent = 'Dodaj produkt';
  ['p-sku','p-name','p-desc','p-price','p-a-w','p-a-l','p-b-w','p-b-l','p-c-w','p-c-l'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('p-stock').value = '0';
  document.getElementById('p-min').value = '2';
  document.getElementById('p-sku').disabled = false;
  document.getElementById('modal-product').style.display = 'flex';
}

function openEditProduct(id) {
  const p = products.find(p => p.id === id);
  if (!p) return;
  editingProductId = id;
  document.getElementById('modal-product-title').textContent = 'Edytuj produkt';
  document.getElementById('p-sku').value = p.sku;
  document.getElementById('p-name').value = p.name;
  document.getElementById('p-desc').value = p.desc || '';
  document.getElementById('p-price').value = p.price || '';
  document.getElementById('p-stock').value = p.stock;
  document.getElementById('p-min').value = p.minStock;
  document.getElementById('p-sku').disabled = true;
  const d = p.dims || {};
  document.getElementById('p-a-w').value = d.aW || '';
  document.getElementById('p-a-l').value = d.aL || '';
  document.getElementById('p-b-w').value = d.bW || '';
  document.getElementById('p-b-l').value = d.bL || '';
  document.getElementById('p-c-w').value = d.cW || '';
  document.getElementById('p-c-l').value = d.cL || '';
  document.getElementById('modal-product').style.display = 'flex';
}

function saveProduct() {
  const sku = document.getElementById('p-sku').value.trim().toUpperCase();
  const name = document.getElementById('p-name').value.trim();
  const desc = document.getElementById('p-desc').value.trim();
  const price = parseFloat(document.getElementById('p-price').value) || 0;
  const stock = parseInt(document.getElementById('p-stock').value) || 0;
  const minStock = parseInt(document.getElementById('p-min').value) || 0;
  const dims = {
    aW: document.getElementById('p-a-w').value || '',
    aL: document.getElementById('p-a-l').value || '',
    bW: document.getElementById('p-b-w').value || '',
    bL: document.getElementById('p-b-l').value || '',
    cW: document.getElementById('p-c-w').value || '',
    cL: document.getElementById('p-c-l').value || '',
  };
  const hasDims = Object.values(dims).some(v => v !== '');

  if (!sku) { document.getElementById('p-sku').classList.add('error'); return; }
  if (!name) { document.getElementById('p-name').classList.add('error'); return; }

  if (editingProductId) {
    const p = products.find(p => p.id === editingProductId);
    if (p) Object.assign(p, { name, desc, price, stock, minStock, dims: hasDims ? dims : null });
  } else {
    if (products.find(p => p.sku === sku)) {
      notify('SKU już istnieje!', 'error');
      document.getElementById('p-sku').classList.add('error');
      return;
    }
    products.push({ id: uid(), sku, name, desc, price, stock, minStock, dims: hasDims ? dims : null });
  }

  save();
  render();
  closeModal('modal-product');
  notify(editingProductId ? '✓ Produkt zaktualizowany' : `✓ Produkt ${sku} dodany`);
}

function deleteProduct(id) {
  const p = products.find(p => p.id === id);
  if (!p || !confirm(`Usunąć "${p.name}"?`)) return;
  products = products.filter(p => p.id !== id);
  save();
  render();
  notify(`🗑 Usunięto: ${p.name}`);
}

// ============================================================
// SKU AUTOCOMPLETE
// ============================================================
function skuAutocomplete(val) {
  const dd = document.getElementById('sku-dropdown');
  const v = val.trim().toUpperCase();

  // Auto-show/hide tartan color picker based on -T in SKU
  checkTartanFromSku(v);

  if (!v) { dd.style.display = 'none'; return; }

  const matches = products.filter(p =>
    p.sku.includes(v) || p.name.toUpperCase().includes(v)
  ).slice(0, 7);

  if (!matches.length) { dd.style.display = 'none'; return; }

  dd.innerHTML = matches.map(p => {
    const col = p.stock === 0 ? 'var(--red)' : p.stock <= p.minStock ? 'var(--amber)' : 'var(--accent-mid)';
    return `<div class="sku-option" onclick="selectSkuOption('${p.sku}')">
      <div>
        <div class="so-name">${p.name}</div>
        <div class="so-sku">${p.sku}</div>
      </div>
      <div class="so-stock" style="color:${col}">${p.stock} szt.</div>
    </div>`;
  }).join('');
  dd.style.display = 'block';
}

function checkTartanFromSku(sku) {
  const isTartan = sku.includes('-T');
  const group = document.getElementById('tartan-group');
  if (!group) return;

  if (isTartan) {
    group.style.display = 'block';
    tartanActive = true;
  } else {
    group.style.display = 'none';
    tartanActive = false;
    tartanColor = null;
    document.querySelectorAll('.tartan-dot').forEach(d => d.classList.remove('selected'));
    const nameEl = document.getElementById('tartan-selected-name');
    if (nameEl) nameEl.textContent = '';
  }
}

function selectSkuOption(sku) {
  document.getElementById('order-sku').value = sku;
  document.getElementById('sku-dropdown').style.display = 'none';
  checkTartanFromSku(sku.toUpperCase());
}

function closeSkuDropdown() {
  const dd = document.getElementById('sku-dropdown');
  if (dd) dd.style.display = 'none';
}

function skuKeydown(e) {
  if (e.key === 'Enter') { closeSkuDropdown(); processOrder(); }
}

// ============================================================
// HELPERS
// ============================================================


// ============================================================
// QUEUE FILTER
// ============================================================
function setQueueFilter(f) {
  queueFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.filter === f);
  });
  renderQueue();
}

function updateFilterCounts() {
  const counts = { wszystkie: 0, nowe: 0, 'w-produkcji': 0, tartanowanie: 0, zakonczone: 0 };
  queue.forEach(item => {
    const s = item.status || 'nowe';
    counts.wszystkie++;
    if (counts[s] !== undefined) counts[s]++;
  });
  Object.keys(counts).forEach(k => {
    const el = document.getElementById('fc-' + k);
    if (el) el.textContent = counts[k];
  });
}


// ============================================================
// ORDER DETAIL MODAL
// ============================================================

// ============================================================
// STATUS TIMELINE
// ============================================================
function buildTimeline(item) {
  const log = item.statusLog || [];
  // Always start with creation if no log
  const entries = log.length > 0 ? log : [{ status: 'nowe', at: item.addedAt, by: item.addedBy }];

  const dotColors = {
    'nowe':         '#1565c0',
    'w-produkcji':  '#e65100',
    'tartanowanie': '#6a1b9a',
    'zakonczone':   '#1b5e20',
  };

  const rows = entries.map((e, i) => {
    const def = getStatusDef(e.status);
    const isLast = i === entries.length - 1;
    return `<div class="timeline-item">
      <div class="timeline-left">
        <div class="timeline-dot" style="background:${dotColors[e.status]||'#888'}">${def.icon}</div>
        ${!isLast ? '<div class="timeline-line"></div>' : ''}
      </div>
      <div class="timeline-content">
        <div class="timeline-label">${def.label}</div>
        <div class="timeline-time">${formatDateTime(e.at)}</div>
        <div class="timeline-by">${e.by === 'biuro' ? '💼 Biuro' : '🔨 Produkcja'}</div>
      </div>
    </div>`;
  }).join('');

  return `<div class="order-detail-section">
    <div class="order-detail-section-title">🕐 Historia statusów</div>
    <div class="timeline">${rows}</div>
  </div>`;
}

function openOrderDetail(id) {
  const item = queue.find(q => q.id === id);
  if (!item) return;
  detailOrderId = id;

  const statusDef = getStatusDef(item.status || 'nowe');
  const isTartan = !!item.tartan;

  // Build status buttons
  let statusBtns = '';
  STATUSES.forEach(s => {
    if (s.key === 'tartanowanie' && !isTartan) return;
    const isActive = (item.status || 'nowe') === s.key;
    statusBtns += `<button class="status-option-btn ${isActive ? 'active-status' : ''}" data-s="${s.key}" onclick="setDetailStatus('${s.key}')">${s.icon} ${s.label}</button>`;
  });

  // Plywood dims from product
  const product = products.find(p => p.sku === item.sku);
  let dimsHtml = '';
  if (product && product.dims) {
    const d = product.dims;
    dimsHtml = `<div class="order-detail-section">
      <div class="order-detail-section-title">📐 Wymiary sklejki</div>
      ${d.aW || d.aL ? `<div class="order-detail-row"><span class="odr-label">Element A</span><span class="odr-value">${d.aW||'—'} × ${d.aL||'—'} cm</span></div>` : ''}
      ${d.bW || d.bL ? `<div class="order-detail-row"><span class="odr-label">Element B</span><span class="odr-value">${d.bW||'—'} × ${d.bL||'—'} cm</span></div>` : ''}
      ${d.cW || d.cL ? `<div class="order-detail-row"><span class="odr-label">Wieko</span><span class="odr-value">${d.cW||'—'} × ${d.cL||'—'} cm</span></div>` : ''}
    </div>`;
  }

  document.getElementById('modal-order-body').innerHTML = `
    <div class="order-detail-header">
      <div>
        <div class="order-detail-name">${item.productName}</div>
        <div class="order-detail-chips">
          <span class="queue-chip">${item.sku}</span>
          <span class="queue-chip qty">📦 ${item.qty} szt.</span>
          ${item.tartan ? `<span class="queue-chip" style="background:${item.tartan.hex};color:white;font-weight:700">🏴 Tartan ${item.tartan.color}</span>` : ''}
          ${item.deadline ? `<span class="queue-chip deadline">⏰ ${formatDate(item.deadline)}</span>` : ''}
        </div>
      </div>
    </div>

    <div class="order-detail-section">
      <div class="order-detail-section-title">📋 Informacje</div>
      <div class="order-detail-row">
        <span class="odr-label">Priorytet</span>
        <span class="odr-value">${['','🔴 Wysoki','🟡 Normalny','🟢 Niski'][item.priority]}</span>
      </div>
      <div class="order-detail-row">
        <span class="odr-label">Dodano</span>
        <span class="odr-value">${formatDateTime(item.addedAt)}</span>
      </div>
      <div class="order-detail-row">
        <span class="odr-label">Przez</span>
        <span class="odr-value">${item.addedBy === 'biuro' ? '💼 Biuro' : '🔨 Produkcja'}</span>
      </div>
      ${item.doneAt ? `<div class="order-detail-row"><span class="odr-label">Ukończono</span><span class="odr-value">${formatDateTime(item.doneAt)}</span></div>` : ''}
    </div>

    ${dimsHtml}

    <div class="order-detail-section">
      <div class="order-detail-section-title">🔄 Status zlecenia</div>
      <div class="status-select-row" id="detail-status-row">${statusBtns}</div>
    </div>

    ${buildTimeline(item)}

    <div class="order-detail-section">
      <div class="order-detail-section-title">📝 Notatki</div>
      <textarea class="order-notes-area" id="order-notes-input" placeholder="Dodaj notatki do zlecenia...">${item.notes || ''}</textarea>
    </div>
  `;

  document.getElementById('modal-order').style.display = 'flex';
}

function setDetailStatus(newStatus) {
  const item = queue.find(q => q.id === detailOrderId);
  if (!item) return;

  const wasZakonczone = item.done;
  const product = products.find(p => p.sku === item.sku);

  // Cofnięcie ze statusu ZAKOŃCZONE — odejmij ze stanu magazynu
  if (wasZakonczone && newStatus !== 'zakonczone') {
    if (product && product.stock >= item.qty) {
      product.stock -= item.qty;
    }
    item.done = false;
    item.doneAt = null;
  }

  // Przejście do ZAKOŃCZONE
  if (newStatus === 'zakonczone' && !wasZakonczone) {
    // Tartan flow: W PRODUKCJI → DO TARTANOWANIA (nie zakończone)
    if (item.tartan && (item.status || 'nowe') === 'w-produkcji') {
      newStatus = 'tartanowanie';
    } else {
      item.done = true;
      item.doneAt = new Date().toISOString();
      if (product) product.stock += item.qty;
    }
  }

  if (!item.statusLog) item.statusLog = [];
  item.statusLog.push({ status: newStatus, at: new Date().toISOString(), by: currentUser });
  item.status = newStatus;

  // Update buttons in modal
  document.querySelectorAll('.status-option-btn').forEach(b => {
    b.classList.toggle('active-status', b.dataset.s === newStatus);
  });

  save(); renderQueue(); renderStock(); renderStats();
  const def = getStatusDef(newStatus);
  notify(`${def.icon} Status: ${def.label}`);
}

function saveOrderDetail() {
  const item = queue.find(q => q.id === detailOrderId);
  if (!item) return;
  const notes = document.getElementById('order-notes-input').value.trim();
  item.notes = notes;
  save();
  closeModal('modal-order');
  notify('💾 Notatki zapisane');
}


// ============================================================
// POS STATE
// ============================================================
let posBasket = [];     // [{ productId, sku, name, qty, priority, tartan }]
let posClientActive = false;
let posOrders = [];     // saved POS orders

function loadPosOrders() {
  // POS orders loaded via Firebase in loadData() — this is now a no-op
}
async function savePosOrders() {
  if (!_dbReady || !window._db) return;
  _isSaving = true;
  try {
    await window._setDoc(window._doc(window._db, 'setgroom', 'pos'), {
      posOrders,
      updatedAt: new Date().toISOString(),
    });
  } catch(e) { console.error('savePosOrders error:', e); }
  setTimeout(() => { _isSaving = false; }, 500);
}

// ============================================================
// POS OPEN / CLOSE
// ============================================================
function openPOS() {
  posBasket = [];
  posClientActive = false;
  document.getElementById('pos-client-check').classList.remove('on');
  document.getElementById('pos-client-fields').classList.remove('visible');
  ['pos-name','pos-phone','pos-email','pos-address'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  document.getElementById('pos-search').value = '';
  renderPosProducts('');
  renderPosBasket();
  document.getElementById('modal-pos').style.display = 'flex';
}

function togglePosClient() {
  posClientActive = !posClientActive;
  document.getElementById('pos-client-check').classList.toggle('on', posClientActive);
  document.getElementById('pos-client-fields').classList.toggle('visible', posClientActive);
}

// ============================================================
// POS PRODUCTS LIST
// ============================================================
function renderPosProducts(filter) {
  const grid = document.getElementById('pos-product-grid');
  if (!grid) return;
  const f = (filter || '').trim().toUpperCase();
  const list = f
    ? products.filter(p => p.sku.includes(f) || p.name.toUpperCase().includes(f))
    : products;

  if (!list.length) {
    grid.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:0.82rem">Brak produktów w katalogu</div>';
    return;
  }

  grid.innerHTML = list.map(p => {
    const isTartan = p.sku.includes('-T');
    const stockColor = p.stock === 0 ? 'var(--red)' : p.stock <= p.minStock ? 'var(--amber)' : 'var(--muted)';
    return `<div class="pos-product-row${p.stock === 0 ? ' out-of-stock' : ''}" onclick="addToBasket('${p.id}')">
      <div class="pos-product-info">
        <div class="pos-product-name">${p.name}</div>
        <div class="pos-product-sku">${p.sku}${isTartan ? ' 🏴' : ''}</div>
      </div>
      <span class="pos-product-stock" style="color:${stockColor}">${p.stock} szt.</span>
      <button class="pos-add-btn" onclick="event.stopPropagation();addToBasket('${p.id}')">+</button>
    </div>`;
  }).join('');
}

// ============================================================
// BASKET
// ============================================================
const TARTAN_COLORS = [
  { color: 'Różowy',      hex: '#e91e8c' },
  { color: 'Niebieski',   hex: '#1565c0' },
  { color: 'Pomarańczowy',hex: '#e65100' },
  { color: 'Fioletowy',   hex: '#6a1b9a' },
  { color: 'Czerwony',    hex: '#c62828' },
];

function addToBasket(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;
  const existing = posBasket.find(b => b.productId === productId);
  if (existing) {
    existing.qty++;
  } else {
    posBasket.push({
      productId,
      sku: product.sku,
      name: product.name,
      qty: 1,
      priority: 2,
      tartan: product.sku.includes('-T') ? null : undefined, // null = tartan required, undefined = not tartan
    });
  }
  renderPosBasket();
}

function removeFromBasket(productId) {
  posBasket = posBasket.filter(b => b.productId !== productId);
  renderPosBasket();
}

function changePosQty(productId, delta) {
  const item = posBasket.find(b => b.productId === productId);
  if (!item) return;
  item.qty = Math.max(1, item.qty + delta);
  renderPosBasket();
}

function setPosPriority(productId, prio) {
  const item = posBasket.find(b => b.productId === productId);
  if (item) item.priority = prio;
  renderPosBasket();
}

function setPosTartan(productId, hex, color) {
  const item = posBasket.find(b => b.productId === productId);
  if (item) item.tartan = { hex, color };
  renderPosBasket();
}

function renderPosBasket() {
  const list = document.getElementById('pos-basket-list');
  const count = document.getElementById('pos-basket-count');
  if (!list) return;

  const total = posBasket.reduce((s, b) => s + b.qty, 0);
  if (count) count.textContent = total > 0 ? `${total} szt.` : '';

  if (!posBasket.length) {
    list.innerHTML = '<div class="pos-basket-empty">Kliknij produkty aby dodać</div>';
    return;
  }

  list.innerHTML = posBasket.map(item => {
    const isTartan = item.tartan !== undefined; // undefined means not a tartan product
    const tartanDots = isTartan ? TARTAN_COLORS.map(tc =>
      `<div class="pos-tartan-dot${item.tartan && item.tartan.hex === tc.hex ? ' selected' : ''}"
        style="background:${tc.hex}" title="${tc.color}"
        onclick="setPosTartan('${item.productId}','${tc.hex}','${tc.color}')"></div>`
    ).join('') : '';

    const tartanStatus = isTartan
      ? (item.tartan
          ? `<span style="font-size:0.65rem;font-weight:700;color:${item.tartan.hex}">🏴 ${item.tartan.color}</span>`
          : `<span style="font-size:0.65rem;color:var(--red);font-weight:600">⚠ Wybierz kolor tartanu</span>`)
      : '';

    return `<div class="pos-basket-item">
      <div class="pos-basket-item-info">
        <div class="pos-basket-item-name">${item.name}</div>
        <div class="pos-basket-item-sku">${item.sku}</div>
        ${isTartan ? `<div class="pos-tartan-dots">${tartanDots}</div>` : ''}
        ${tartanStatus ? `<div style="margin-top:2px">${tartanStatus}</div>` : ''}
        <div class="pos-prio-select">
          <button class="pos-prio-btn${item.priority===1?' sel-1':''}" onclick="setPosPriority('${item.productId}',1)">🔴</button>
          <button class="pos-prio-btn${item.priority===2?' sel-2':''}" onclick="setPosPriority('${item.productId}',2)">🟡</button>
          <button class="pos-prio-btn${item.priority===3?' sel-3':''}" onclick="setPosPriority('${item.productId}',3)">🟢</button>
        </div>
      </div>
      <div class="pos-qty-ctrl">
        <button onclick="changePosQty('${item.productId}',-1)">−</button>
        <span>${item.qty}</span>
        <button onclick="changePosQty('${item.productId}',1)">+</button>
      </div>
      <button class="pos-remove-btn" onclick="removeFromBasket('${item.productId}')">✕</button>
    </div>`;
  }).join('');
}

// ============================================================
// SUBMIT POS ORDER
// ============================================================
async function submitPosOrder() {
  if (!posBasket.length) { notify('Koszyk jest pusty!', 'error'); return; }

  // Validate tartan colors
  const missingTartan = posBasket.filter(b => b.tartan === null); // null = required but not set
  if (missingTartan.length) {
    notify(`⚠ Wybierz kolor tartanu dla: ${missingTartan.map(b=>b.name).join(', ')}`, 'error');
    return;
  }

  // Collect client data
  let client = null;
  if (posClientActive) {
    client = {
      name:    document.getElementById('pos-name').value.trim(),
      phone:   document.getElementById('pos-phone').value.trim(),
      email:   document.getElementById('pos-email').value.trim(),
      address: document.getElementById('pos-address').value.trim(),
    };
  }

  const orderId = uid();
  const orderTime = new Date().toISOString();

  // Save POS order
  const posOrder = {
    id: orderId,
    createdAt: orderTime,
    createdBy: currentUser,
    client,
    items: posBasket.map(b => ({ ...b })),
  };
  loadPosOrders();
  posOrders.unshift(posOrder);
  await savePosOrders();

  // Split into individual queue items
  let addedCount = 0;
  posBasket.forEach(item => {
    const product = products.find(p => p.id === item.productId);
    if (!product) return;

    const needQty = item.qty;
    const fromStock = Math.min(product.stock, needQty);
    const toQueue = needQty - fromStock;
    product.stock -= fromStock;

    if (toQueue > 0) {
      queue.push({
        id: uid(),
        sku: product.sku,
        productName: product.name,
        qty: toQueue,
        priority: item.priority,
        deadline: null,
        addedAt: orderTime,
        addedBy: currentUser,
        tartan: item.tartan || null,
        status: 'nowe',
        done: false,
        posOrderId: orderId,
        clientName: client ? client.name : null,
        statusLog: [{ status: 'nowe', at: orderTime, by: currentUser }]
      });
      addedCount++;
    }

    orderHistory.push({
      id: uid(),
      sku: product.sku,
      productName: product.name,
      qty: needQty,
      time: orderTime,
      action: toQueue > 0 ? 'queue' : 'stock',
      by: currentUser,
      tartan: item.tartan || null,
      posOrderId: orderId,
    });
  });

  save();
  render();
  renderPosOrdersList();
  closeModal('modal-pos');

  const msg = addedCount > 0
    ? `✓ Zamówienie POS zapisane — ${addedCount} pozycji dodano do kolejki`
    : `✓ Zamówienie POS zapisane — wszystko dostępne na stanie`;
  notify(msg);
}

// ============================================================
// POS ORDERS LIST
// ============================================================

// ============================================================
// KALKULATOR MATERIAŁOWY
// ============================================================
function renderCalc() {
  const container = document.getElementById('calc-container');
  if (!container) return;

  const sheetW = parseFloat(document.getElementById('sheet-w')?.value) || 122;
  const sheetL = parseFloat(document.getElementById('sheet-l')?.value) || 244;
  const margin = (parseFloat(document.getElementById('sheet-margin')?.value) || 10) / 100;
  const sheetArea = sheetW * sheetL;

  // Only active (not done) queue items
  const active = queue.filter(q => !q.done);

  if (!active.length) {
    container.innerHTML = '<div class="calc-empty"><div style="font-size:2rem">🎉</div><div style="margin-top:8px;font-weight:600">Kolejka pusta — nic do wyliczenia</div></div>';
    return;
  }

  // Group by SKU, sum quantities
  const bySkuMap = {};
  active.forEach(item => {
    if (!bySkuMap[item.sku]) {
      const product = products.find(p => p.sku === item.sku);
      bySkuMap[item.sku] = { sku: item.sku, name: item.productName, qty: 0, dims: product?.dims || null };
    }
    bySkuMap[item.sku].qty += item.qty;
  });

  const skuList = Object.values(bySkuMap).sort((a,b) => b.qty - a.qty);

  // Total sheet calculation (only for items with dims)
  let totalArea = 0;
  let itemsWithDims = 0;

  skuList.forEach(s => {
    if (!s.dims) return;
    const d = s.dims;
    const aArea = (parseFloat(d.aW)||0) * (parseFloat(d.aL)||0);
    const bArea = (parseFloat(d.bW)||0) * (parseFloat(d.bL)||0);
    const cArea = (parseFloat(d.cW)||0) * (parseFloat(d.cL)||0);
    const pieceArea = aArea + bArea + cArea;
    if (pieceArea > 0) {
      totalArea += pieceArea * s.qty;
      itemsWithDims++;
    }
  });

  const totalWithMargin = totalArea * (1 + margin);
  const sheetsNeeded = sheetArea > 0 && totalArea > 0 ? Math.ceil(totalWithMargin / sheetArea) : null;

  let html = '';

  // Sheet summary header
  if (sheetsNeeded !== null) {
    html += `<div class="calc-sheet-info">
      <div class="calc-sheet-number">${sheetsNeeded}</div>
      <div>
        <div style="font-size:1rem">arkuszy sklejki ${sheetW}×${sheetL} cm</div>
        <div style="font-size:0.72rem;font-weight:400;color:var(--accent-mid);margin-top:2px">
          Powierzchnia: ${(totalArea/10000).toFixed(2)} m² + ${(margin*100).toFixed(0)}% zapas = ${(totalWithMargin/10000).toFixed(2)} m²
        </div>
      </div>
    </div>`;
    if (itemsWithDims < skuList.length) {
      const missing = skuList.length - itemsWithDims;
      html += `<div style="font-size:0.75rem;color:var(--amber);margin-bottom:12px;padding:8px 12px;background:var(--amber-bg);border-radius:8px">
        ⚠ ${missing} SKU nie ma wpisanych wymiarów w katalogu — nie są uwzględnione w obliczeniach
      </div>`;
    }
  } else {
    html += `<div style="font-size:0.78rem;color:var(--muted);margin-bottom:16px;padding:10px 14px;background:var(--card);border-radius:8px">
      📐 Dodaj wymiary sklejki do produktów w Katalogu żeby zobaczyć ile arkuszy potrzebujesz
    </div>`;
  }

  // Cards per SKU
  html += '<div class="calc-summary-grid">';
  skuList.forEach(s => {
    let dimsHtml = '';
    if (s.dims) {
      const d = s.dims;
      const rows = [
        d.aW && d.aL ? `<div class="calc-dim-row"><span class="calc-dim-label">Element A</span><span>${d.aW} × ${d.aL} cm</span></div>` : '',
        d.bW && d.bL ? `<div class="calc-dim-row"><span class="calc-dim-label">Element B</span><span>${d.bW} × ${d.bL} cm</span></div>` : '',
        d.cW && d.cL ? `<div class="calc-dim-row"><span class="calc-dim-label">Wieko</span><span>${d.cW} × ${d.cL} cm</span></div>` : '',
      ].filter(Boolean).join('');
      if (rows) dimsHtml = `<div class="calc-card-dims">${rows}</div>`;
      else dimsHtml = '<div class="calc-no-dims">Brak wymiarów</div>';
    } else {
      dimsHtml = '<div class="calc-no-dims">Brak wymiarów w katalogu</div>';
    }

    html += `<div class="calc-card">
      <div class="calc-card-sku">${s.sku}</div>
      <div class="calc-card-name" title="${s.name}">${s.name}</div>
      <div class="calc-card-qty">${s.qty}</div>
      <div class="calc-card-unit">szt. do wyprodukowania</div>
      ${dimsHtml}
    </div>`;
  });
  html += '</div>';

  container.innerHTML = html;
}


// ============================================================
// PDF EXPORT — POS Order
// ============================================================
function exportPosPDF(orderId) {
  const order = posOrders.find(o => o.id === orderId);
  if (!order) return;

  const c = order.client || {};
  const dateStr = new Date(order.createdAt).toLocaleDateString('pl-PL', { year:'numeric', month:'long', day:'numeric' });
  const timeStr = new Date(order.createdAt).toLocaleTimeString('pl-PL', { hour:'2-digit', minute:'2-digit' });

  const itemRows = order.items.map(it => `
    <tr>
      <td style="padding:8px 12px;border-bottom:1px solid #eee;font-family:monospace;font-size:13px">${it.sku}</td>
      <td style="padding:8px 12px;border-bottom:1px solid #eee">${it.name}</td>
      <td style="padding:8px 12px;border-bottom:1px solid #eee;text-align:center">${it.qty}</td>
      <td style="padding:8px 12px;border-bottom:1px solid #eee;text-align:center">${it.tartan ? `<span style="background:${it.tartan.hex};color:white;padding:2px 8px;border-radius:10px;font-size:12px">🏴 ${it.tartan.color}</span>` : '—'}</td>
    </tr>`).join('');

  const html = `<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Zamówienie POS — ${c.name || 'Klient anonimowy'}</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', Arial, sans-serif; color: #1a1a1a; background: white; padding: 32px 40px; }
  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 28px; padding-bottom: 20px; border-bottom: 3px solid #1e3d0f; }
  .logo { font-size: 28px; font-weight: 900; color: #1e3d0f; letter-spacing: -1px; }
  .logo span { color: #4a9e20; }
  .doc-title { font-size: 13px; color: #666; margin-top: 4px; }
  .doc-meta { text-align: right; font-size: 13px; color: #666; }
  .doc-date { font-size: 15px; font-weight: 700; color: #1a1a1a; margin-bottom: 4px; }
  .client-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  .section-card { background: #f7f5f0; border-radius: 10px; padding: 14px 18px; }
  .section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 8px; }
  .client-name { font-size: 18px; font-weight: 800; color: #1e3d0f; margin-bottom: 4px; }
  .client-info { font-size: 13px; color: #555; line-height: 1.6; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  thead { background: #1e3d0f; color: white; }
  thead th { padding: 10px 12px; text-align: left; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; }
  .total-row { background: #f0f7e8; font-weight: 700; }
  .total-row td { padding: 10px 12px; font-size: 15px; }
  .footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #ddd; font-size: 11px; color: #999; display: flex; justify-content: space-between; }
  .status-badge { display: inline-block; background: #e8f5e9; color: #1b5e20; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }
  @media print {
    body { padding: 16px 20px; }
    .no-print { display: none; }
  }
</style>
</head>
<body>
  <div class="header">
    <div>
      <div class="logo">Set<span>Groom</span></div>
      <div class="doc-title">Potwierdzenie zamówienia POS</div>
    </div>
    <div class="doc-meta">
      <div class="doc-date">${dateStr}</div>
      <div>Godzina: ${timeStr}</div>
      <div style="margin-top:6px"><span class="status-badge">Zamówienie przyjęte</span></div>
    </div>
  </div>

  <div class="client-section">
    <div class="section-card">
      <div class="section-title">Dane klienta</div>
      ${c.name ? `<div class="client-name">${c.name}</div>` : '<div class="client-name" style="color:#999">Klient anonimowy</div>'}
      <div class="client-info">
        ${c.phone ? `📞 ${c.phone}<br>` : ''}
        ${c.email ? `✉ ${c.email}<br>` : ''}
        ${c.address ? `📍 ${c.address}` : ''}
        ${!c.phone && !c.email && !c.address ? '<span style="color:#bbb">Brak danych kontaktowych</span>' : ''}
      </div>
    </div>
    <div class="section-card">
      <div class="section-title">Podsumowanie</div>
      <div style="font-size:13px;color:#555;line-height:1.8">
        Pozycji: <strong>${order.items.length}</strong><br>
        Łącznie sztuk: <strong>${order.items.reduce((s,i)=>s+i.qty,0)}</strong><br>
        Przyjął: <strong>${order.createdBy === 'biuro' ? 'Biuro' : 'Produkcja'}</strong>
      </div>
    </div>
  </div>

  <div class="section-title" style="margin-bottom:8px">Zamówione produkty</div>
  <table>
    <thead>
      <tr>
        <th>SKU</th>
        <th>Produkt</th>
        <th style="text-align:center">Ilość</th>
        <th style="text-align:center">Tartan</th>
      </tr>
    </thead>
    <tbody>
      ${itemRows}
      <tr class="total-row">
        <td colspan="2">Łącznie</td>
        <td style="text-align:center">${order.items.reduce((s,i)=>s+i.qty,0)} szt.</td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <div class="footer">
    <span>SetGroom — System Produkcji</span>
    <span>ID zamówienia: ${order.id.slice(0,8).toUpperCase()}</span>
  </div>

  <script>window.onload = () => { window.print(); }<\/script>
</body>
</html>`;

  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const win = window.open(url, '_blank');
  if (!win) notify('Zezwól na pop-upy żeby otworzyć PDF', 'warn');
}

function renderPosOrdersList() {
  loadPosOrders();
  const container = document.getElementById('pos-orders-container');
  if (!container) return;

  if (!posOrders.length) {
    container.innerHTML = `<div class="empty">
      <div class="empty-icon">🛒</div>
      <div class="empty-title">Brak zamówień POS</div>
      <div class="empty-sub">Kliknij "+ Nowe zamówienie POS" aby dodać</div>
    </div>`;
    return;
  }

  container.innerHTML = posOrders.map(order => {
    const c = order.client;
    const clientHtml = c && c.name
      ? `<div class="pos-order-client-name">👤 ${c.name}</div>
         <div class="pos-order-meta">${[c.phone,c.email,c.address].filter(Boolean).join(' · ')}</div>`
      : `<div class="pos-order-client-name" style="color:var(--muted)">Klient anonimowy</div>`;

    const itemsHtml = order.items.map(it =>
      `<div class="pos-order-item-row">
        <span class="sku-badge" style="font-size:0.62rem">${it.sku}</span>
        <span>${it.name}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:0.72rem">×${it.qty}</span>
        ${it.tartan ? `<span style="background:${it.tartan.hex};color:white;font-size:0.65rem;font-weight:700;padding:1px 7px;border-radius:10px">🏴 ${it.tartan.color}</span>` : ''}
      </div>`
    ).join('');

    return `<div class="pos-order-card">
      <div class="pos-order-card-header">
        <div>${clientHtml}</div>
        <div style="text-align:right;flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div style="font-size:0.68rem;color:var(--muted);font-family:'JetBrains Mono',monospace">${formatDateTime(order.createdAt)}</div>
          <div style="font-size:0.72rem;color:var(--muted)">${order.items.reduce((s,i)=>s+i.qty,0)} szt. · ${order.createdBy==='biuro'?'💼':'🔨'}</div>
          <button class="btn-pdf" onclick="exportPosPDF('${order.id}')">🖨 PDF</button>
        </div>
      </div>
      <div class="pos-order-items">${itemsHtml}</div>
    </div>`;
  }).join('');
}


// ============================================================
// TARTAN
// ============================================================
// toggleTartan no longer used — tartan auto-detected from SKU containing "-T"
function toggleTartan() {}

function selectTartan(el) {
  event.stopPropagation();
  document.querySelectorAll('.tartan-dot').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');
  tartanColor = { color: el.dataset.color, hex: el.dataset.hex };

  const nameEl = document.getElementById('tartan-selected-name');
  if (nameEl) {
    nameEl.textContent = '✓ Wybrany kolor: ' + el.dataset.color;
    nameEl.style.color = 'var(--accent-mid)';
  }
}

function resetTartan() {
  tartanActive = false;
  tartanColor = null;
  const group = document.getElementById('tartan-group');
  if (group) group.style.display = 'none';
  document.querySelectorAll('.tartan-dot').forEach(d => d.classList.remove('selected'));
  const nameEl = document.getElementById('tartan-selected-name');
  if (nameEl) nameEl.textContent = '';
}

function selectPrio(p) {
  selectedPrio = p;
  document.querySelectorAll('.prio-opt').forEach(el =>
    el.classList.toggle('selected', parseInt(el.dataset.p) === p)
  );
}

function filterCatalog(val) {
  catalogFilter = val;
  renderCatalog(val);
}

function changeQty(inputId, delta) {
  const inp = document.getElementById(inputId);
  if (inp) inp.value = Math.max(0, (parseInt(inp.value) || 0) + delta);
}

function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

function formatDate(str) {
  if (!str) return '';
  const d = new Date(str + 'T00:00:00');
  return d.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatDateTime(str) {
  if (!str) return '';
  const d = new Date(str);
  return d.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' }) + ' ' +
    d.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
}

let notifTimeout;

// ============================================================
// SERVICE WORKER — Offline mode
// ============================================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      console.log('[SW] Registered:', reg.scope);
    }).catch(err => console.warn('[SW] Registration failed:', err));
  });
}

// Offline / Online detection
window.addEventListener('offline', () => {
  document.getElementById('offline-banner')?.classList.add('visible');
});
window.addEventListener('online', () => {
  document.getElementById('offline-banner')?.classList.remove('visible');
  notify('✅ Połączenie przywrócone — synchronizacja...');
});
if (!navigator.onLine) {
  document.getElementById('offline-banner')?.classList.add('visible');
}


// ============================================================
// PUSH NOTIFICATIONS
// ============================================================
let _notifPermission = 'default';
let _notifDismissed = false;

function initNotifications() {
  if (!('Notification' in window)) return;
  _notifPermission = Notification.permission;
  if (_notifPermission === 'default' && !localStorage.getItem('sg-notif-dismissed')) {
    setTimeout(() => {
      document.getElementById('notif-permission-bar')?.classList.add('visible');
    }, 3000);
  }
}

function requestNotifPermission() {
  if (!('Notification' in window)) { notify('Twoja przeglądarka nie obsługuje powiadomień', 'error'); return; }
  Notification.requestPermission().then(result => {
    _notifPermission = result;
    document.getElementById('notif-permission-bar')?.classList.remove('visible');
    if (result === 'granted') {
      notify('🔔 Powiadomienia włączone!');
      sendPushNotif('SetGroom', '🔔 Powiadomienia działają poprawnie!', 'test');
    } else {
      notify('Powiadomienia zablokowane w przeglądarce', 'warn');
    }
  });
}

function dismissNotifBar() {
  document.getElementById('notif-permission-bar')?.classList.remove('visible');
  localStorage.setItem('sg-notif-dismissed', '1');
}

function sendPushNotif(title, body, tag) {
  if (_notifPermission !== 'granted') return;
  // Use SW if available for better mobile support
  if (navigator.serviceWorker?.controller) {
    navigator.serviceWorker.controller.postMessage({ type: 'NOTIFY', title, body, tag });
  } else if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, { body, tag, renotify: true, icon: './favicon.ico' });
  }
}

// Check low stock and send notification
let _lastLowStockAlert = {};
function checkLowStockNotif() {
  if (_notifPermission !== 'granted') return;
  const lowItems = products.filter(p => p.stock <= p.minStock && p.stock >= 0);
  lowItems.forEach(p => {
    const key = `${p.sku}-${p.stock}`;
    if (_lastLowStockAlert[p.sku] !== key) {
      _lastLowStockAlert[p.sku] = key;
      const msg = p.stock === 0
        ? `⊘ BRAK TOWARU: ${p.name} (${p.sku})`
        : `⚠ Niski stan: ${p.name} — ${p.stock} szt. (min: ${p.minStock})`;
      sendPushNotif('SetGroom — Stan magazynu', msg, 'stock-' + p.sku);
    }
  });
}

// Check for tartanowanie status changes
let _notifiedTartanIds = new Set(JSON.parse(localStorage.getItem('sg-notified-tartan') || '[]'));
function checkTartanNotif() {
  if (_notifPermission !== 'granted') return;
  const tartanItems = queue.filter(q => q.status === 'tartanowanie' && !_notifiedTartanIds.has(q.id));
  tartanItems.forEach(item => {
    _notifiedTartanIds.add(item.id);
    sendPushNotif(
      'SetGroom — Do tartanowania! 🏴',
      `${item.productName} (${item.qty} szt.) czeka na tartanowanie`,
      'tartan-' + item.id
    );
  });
  if (tartanItems.length > 0) {
    localStorage.setItem('sg-notified-tartan', JSON.stringify([..._notifiedTartanIds]));
  }
}


// ============================================================
// STATYSTYKI
// ============================================================
function statsPreset(range) {
  const now = new Date();
  const toStr = now.toISOString().split('T')[0];
  let fromDate = new Date();
  if (range === 'week')  fromDate.setDate(now.getDate() - 7);
  if (range === 'month') fromDate.setDate(now.getDate() - 30);
  if (range === 'all')   fromDate = new Date('2020-01-01');
  const fromStr = fromDate.toISOString().split('T')[0];
  document.getElementById('stats-from').value = fromStr;
  document.getElementById('stats-to').value   = toStr;
  renderStatsView();
}

function renderStatsView() {
  const container = document.getElementById('stats-container');
  if (!container) return;

  const fromVal = document.getElementById('stats-from')?.value;
  const toVal   = document.getElementById('stats-to')?.value;
  const fromTs  = fromVal ? new Date(fromVal).getTime() : 0;
  const toTs    = toVal   ? new Date(toVal + 'T23:59:59').getTime() : Date.now();

  // Filter completed queue items in range
  const completed = queue.filter(q => {
    if (!q.done || !q.doneAt) return false;
    const t = new Date(q.doneAt).getTime();
    return t >= fromTs && t <= toTs;
  });

  const allInRange = queue.filter(q => {
    const t = new Date(q.addedAt).getTime();
    return t >= fromTs && t <= toTs;
  });

  // ---- KPIs ----
  const totalProduced = completed.reduce((s, q) => s + q.qty, 0);
  const totalOrders   = completed.length;
  const tartanCount   = completed.filter(q => q.tartan).reduce((s,q) => s+q.qty, 0);

  // Avg production time (items with full statusLog: nowe → zakonczone)
  let totalMs = 0, timeCount = 0;
  completed.forEach(q => {
    if (!q.statusLog || q.statusLog.length < 2) return;
    const start = new Date(q.statusLog[0].at).getTime();
    const end   = new Date(q.doneAt).getTime();
    if (end > start) { totalMs += (end - start); timeCount++; }
  });
  const avgHours = timeCount > 0 ? (totalMs / timeCount / 3600000) : null;
  const avgLabel = avgHours === null ? '—'
    : avgHours < 1 ? `${Math.round(avgHours*60)} min`
    : avgHours < 24 ? `${avgHours.toFixed(1)} h`
    : `${(avgHours/24).toFixed(1)} dni`;

  // ---- SKU ranking ----
  const skuMap = {};
  completed.forEach(q => {
    if (!skuMap[q.sku]) skuMap[q.sku] = { sku: q.sku, name: q.productName, qty: 0, tartan: !!q.tartan };
    skuMap[q.sku].qty += q.qty;
  });
  const skuRanking = Object.values(skuMap).sort((a,b) => b.qty - a.qty).slice(0, 10);
  const maxQty = skuRanking[0]?.qty || 1;

  // ---- Production time by SKU ----
  const skuTimeMap = {};
  completed.forEach(q => {
    if (!q.statusLog || q.statusLog.length < 2) return;
    const ms = new Date(q.doneAt).getTime() - new Date(q.statusLog[0].at).getTime();
    if (ms <= 0) return;
    if (!skuTimeMap[q.sku]) skuTimeMap[q.sku] = { sku: q.sku, name: q.productName, totalMs: 0, count: 0 };
    skuTimeMap[q.sku].totalMs += ms;
    skuTimeMap[q.sku].count++;
  });
  const skuTimes = Object.values(skuTimeMap)
    .map(s => ({ ...s, avgMs: s.totalMs / s.count }))
    .sort((a,b) => a.avgMs - b.avgMs)
    .slice(0, 8);

  function fmtDuration(ms) {
    const h = ms / 3600000;
    if (h < 1) return Math.round(h*60) + ' min';
    if (h < 24) return h.toFixed(1) + ' h';
    return (h/24).toFixed(1) + ' dni';
  }

  // ---- BUILD HTML ----
  let html = '';

  // KPIs
  html += `<div class="stats-kpi-row">
    <div class="stats-kpi">
      <div class="stats-kpi-value">${totalProduced}</div>
      <div class="stats-kpi-label">Wyprodukowanych sztuk</div>
    </div>
    <div class="stats-kpi">
      <div class="stats-kpi-value">${totalOrders}</div>
      <div class="stats-kpi-label">Ukończonych zleceń</div>
    </div>
    <div class="stats-kpi">
      <div class="stats-kpi-value">${tartanCount}</div>
      <div class="stats-kpi-label">Sztuk z tartanem 🏴</div>
    </div>
    <div class="stats-kpi">
      <div class="stats-kpi-value" style="font-size:1.5rem">${avgLabel}</div>
      <div class="stats-kpi-label">Średni czas produkcji</div>
      ${timeCount > 0 ? `<div class="stats-kpi-sub">na podstawie ${timeCount} zleceń</div>` : ''}
    </div>
  </div>`;

  if (completed.length === 0) {
    html += `<div class="stats-empty">
      <div style="font-size:2rem">📊</div>
      <div style="margin-top:8px;font-weight:600">Brak ukończonych zleceń w wybranym okresie</div>
      <div style="margin-top:4px;font-size:0.78rem">Zmień zakres dat lub poczekaj na zakończenie pierwszych zleceń</div>
    </div>`;
    container.innerHTML = html;
    return;
  }

  // SKU Ranking
  if (skuRanking.length > 0) {
    const bars = skuRanking.map(s => {
      const pct = Math.max(10, (s.qty / maxQty) * 100);
      return `<div class="bar-row">
        <div class="bar-label" title="${s.name}">${s.sku}</div>
        <div class="bar-track">
          <div class="bar-fill ${s.tartan ? 'bar-fill-tartan' : ''}" style="width:${pct}%">
            <span class="bar-value">${s.qty}</span>
          </div>
        </div>
      </div>`;
    }).join('');
    html += `<div class="stats-section">
      <div class="stats-section-title">🏆 Najpopularniejsze SKU <span style="font-size:0.72rem;font-weight:400;color:var(--muted)">(wyprodukowane sztuki)</span></div>
      <div class="bar-chart">${bars}</div>
    </div>`;
  }

  // Production time per SKU
  if (skuTimes.length > 0) {
    const rows = skuTimes.map(s => `<div class="time-row">
      <div class="time-sku">${s.sku}</div>
      <div class="time-name">${s.name}</div>
      <div class="time-duration">${fmtDuration(s.avgMs)}</div>
      <div class="time-count">${s.count}×</div>
    </div>`).join('');
    html += `<div class="stats-section">
      <div class="stats-section-title">⏱ Średni czas produkcji per SKU <span style="font-size:0.72rem;font-weight:400;color:var(--muted)">(od dodania do zakończenia)</span></div>
      <div class="time-chart">${rows}</div>
    </div>`;
  }

  container.innerHTML = html;
}

function notify(msg, type = '') {
  const ex = document.getElementById('notif');
  if (ex) ex.remove();
  clearTimeout(notifTimeout);
  const el = document.createElement('div');
  el.id = 'notif';
  el.className = 'notification' + (type ? ' ' + type : '');
  el.textContent = msg;
  document.body.appendChild(el);
  notifTimeout = setTimeout(() => el.remove(), 3500);
}

// Uppercase SKU
document.addEventListener('DOMContentLoaded', () => {
  const skuInput = document.getElementById('order-sku');
  if (skuInput) {
    skuInput.addEventListener('input', function() {
      const pos = this.selectionStart;
      this.value = this.value.toUpperCase();
      this.setSelectionRange(pos, pos);
    });
  }

  // Wait for Firebase → hide loading overlay → show login screen
  function onFirebaseReady() {
    const overlay = document.getElementById('loading-overlay');
    const loginScreen = document.getElementById('login-screen');
    if (overlay) { overlay.classList.add('hidden'); setTimeout(() => overlay.style.display='none', 400); }
    if (loginScreen) loginScreen.style.display = 'flex';
  }

  if (window._firebaseReady) {
    onFirebaseReady();
  } else {
    window.addEventListener('firebase-ready', onFirebaseReady, { once: true });
    // Fallback after 6s if Firebase fails to load
    setTimeout(onFirebaseReady, 6000);
  }
});
</script>
</body>
</html>
