<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SetGroom ‚Äî System Produkcji</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f7f5f0;
  --surface: #ffffff;
  --card: #f0ece3;
  --border: #e4ddd0;
  --border2: #cfc5b0;
  --accent: #1e3d0f;
  --accent-mid: #2d5a18;
  --accent-light: #3d7a20;
  --accent-bg: #eaf3e2;
  --amber: #b86e10;
  --amber-bg: #fef0d8;
  --red: #b52d20;
  --red-bg: #fce8e6;
  --text: #18140e;
  --text2: #4a4030;
  --muted: #8a7f6e;
  --shadow: 0 2px 10px rgba(30,61,15,0.07);
  --shadow-lg: 0 8px 28px rgba(30,61,15,0.13);
  --header-h: 60px;
  --bottom-nav-h: 64px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body { height: 100%; overflow: hidden; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  display: flex;
  flex-direction: column;
}

/* ===================== LOGIN SCREEN ===================== */
#login-screen {
  position: fixed;
  inset: 0;
  background: var(--accent);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 24px;
}

#login-screen::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 30% 20%, rgba(61,122,32,0.4) 0%, transparent 60%),
              radial-gradient(ellipse at 80% 80%, rgba(30,61,15,0.6) 0%, transparent 50%);
  pointer-events: none;
}

.login-logo {
  font-family: 'Syne', sans-serif;
  font-size: 2.8rem;
  font-weight: 800;
  color: white;
  letter-spacing: -1px;
  margin-bottom: 6px;
  position: relative;
  z-index: 1;
}

.login-logo span { color: #8fcf5a; }

.login-sub {
  color: rgba(255,255,255,0.55);
  font-size: 0.8rem;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  margin-bottom: 52px;
  position: relative;
  z-index: 1;
}

.login-label {
  color: rgba(255,255,255,0.6);
  font-size: 0.78rem;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: 16px;
  position: relative;
  z-index: 1;
}

.login-cards {
  display: flex;
  gap: 16px;
  position: relative;
  z-index: 1;
  flex-wrap: wrap;
  justify-content: center;
  width: 100%;
  max-width: 460px;
}

.login-card {
  flex: 1;
  min-width: 180px;
  background: rgba(255,255,255,0.08);
  border: 1.5px solid rgba(255,255,255,0.15);
  border-radius: 18px;
  padding: 28px 20px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  backdrop-filter: blur(10px);
}

.login-card:hover, .login-card:active {
  background: rgba(255,255,255,0.16);
  border-color: rgba(255,255,255,0.4);
  transform: translateY(-3px);
  box-shadow: 0 16px 40px rgba(0,0,0,0.3);
}

.login-card-icon { font-size: 2.6rem; margin-bottom: 12px; }
.login-card-name {
  font-family: 'Syne', sans-serif;
  font-size: 1.3rem;
  font-weight: 700;
  color: white;
  margin-bottom: 6px;
}
.login-card-desc { font-size: 0.78rem; color: rgba(255,255,255,0.5); line-height: 1.4; }

/* ===================== HEADER ===================== */
header {
  background: var(--accent);
  color: white;
  height: var(--header-h);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  position: sticky;
  top: 0;
  z-index: 100;
  flex-shrink: 0;
  box-shadow: 0 2px 12px rgba(30,61,15,0.25);
}

.logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 1.25rem;
  letter-spacing: -0.5px;
  color: white;
}

.logo span { color: #8fcf5a; }

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-pill {
  background: rgba(255,255,255,0.15);
  border-radius: 20px;
  padding: 5px 12px 5px 8px;
  display: flex;
  align-items: center;
  gap: 7px;
  font-size: 0.82rem;
  color: white;
  font-weight: 500;
}

.user-pill-icon { font-size: 1rem; }

.btn-logout {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: rgba(255,255,255,0.7);
  border-radius: 8px;
  padding: 5px 10px;
  font-size: 0.75rem;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  transition: all 0.15s;
}
.btn-logout:hover { background: rgba(255,255,255,0.2); color: white; }

/* Desktop nav */
.desktop-nav {
  display: flex;
  gap: 2px;
}

.nav-tab {
  padding: 7px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.82rem;
  font-weight: 500;
  color: rgba(255,255,255,0.6);
  transition: all 0.18s;
  border: none;
  background: transparent;
  font-family: 'Outfit', sans-serif;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.nav-tab:hover { color: white; background: rgba(255,255,255,0.1); }
.nav-tab.active { color: white; background: rgba(255,255,255,0.18); }

.nav-badge {
  background: var(--amber);
  color: white;
  border-radius: 10px;
  padding: 1px 6px;
  font-size: 0.68rem;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  min-width: 18px;
  text-align: center;
}

/* ===================== MAIN SCROLL ===================== */
#app-shell {
  display: none;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
}

.main-scroll {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 24px 20px;
  padding-bottom: calc(var(--bottom-nav-h) + 20px);
}

/* ===================== BOTTOM NAV (mobile) ===================== */
.bottom-nav {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: var(--bottom-nav-h);
  background: var(--accent);
  border-top: 1px solid rgba(255,255,255,0.1);
  z-index: 100;
  flex-shrink: 0;
}

.bottom-nav-inner {
  display: flex;
  height: 100%;
  align-items: stretch;
}

.bnav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  cursor: pointer;
  color: rgba(255,255,255,0.5);
  transition: all 0.15s;
  position: relative;
  border: none;
  background: transparent;
  font-family: 'Outfit', sans-serif;
  -webkit-tap-highlight-color: transparent;
}

.bnav-item.active { color: white; }
.bnav-item.active::after {
  content: '';
  position: absolute;
  bottom: 0; left: 20%; right: 20%;
  height: 3px;
  background: #8fcf5a;
  border-radius: 2px 2px 0 0;
}

.bnav-icon { font-size: 1.3rem; line-height: 1; position: relative; }
.bnav-label { font-size: 0.62rem; font-weight: 500; letter-spacing: 0.3px; }

.bnav-badge {
  position: absolute;
  top: -4px; right: -8px;
  background: var(--amber);
  color: white;
  border-radius: 8px;
  padding: 0 5px;
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  min-width: 16px;
  text-align: center;
  line-height: 16px;
  height: 16px;
}

/* ===================== VIEWS ===================== */
.view { display: none; }
.view.active { display: block; }

/* ===================== PAGE HEADER ===================== */
.page-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}

.page-title {
  font-family: 'Syne', sans-serif;
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--accent);
  letter-spacing: -0.3px;
}

.page-subtitle { font-size: 0.82rem; color: var(--muted); margin-top: 2px; }

/* ===================== BUTTONS ===================== */
.btn {
  padding: 10px 18px;
  border-radius: 10px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.88rem;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all 0.18s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  -webkit-tap-highlight-color: transparent;
}

.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover, .btn-primary:active { background: var(--accent-light); }

.btn-secondary { background: var(--surface); color: var(--text2); border: 1px solid var(--border2); }
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

.btn-success { background: var(--accent-bg); color: var(--accent-mid); border: 1px solid rgba(45,90,24,0.2); }
.btn-success:hover { background: var(--accent-mid); color: white; }

.btn-danger { background: var(--red-bg); color: var(--red); border: 1px solid transparent; }
.btn-danger:hover { border-color: var(--red); }

.btn-sm { padding: 6px 12px; font-size: 0.78rem; }
.btn-full { width: 100%; justify-content: center; padding: 14px; font-size: 0.95rem; }

/* ===================== STATS ===================== */
.stats-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px 18px;
  box-shadow: var(--shadow);
}

.stat-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 500; margin-bottom: 6px; }
.stat-value { font-family: 'Syne', sans-serif; font-size: 1.9rem; font-weight: 800; color: var(--accent); line-height: 1; }
.stat-sub { font-size: 0.7rem; color: var(--muted); margin-top: 3px; }
.stat-card.warn .stat-value { color: var(--amber); }
.stat-card.danger .stat-value { color: var(--red); }

/* ===================== ORDER PANEL ===================== */
.order-form-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
}

.panel-title {
  font-family: 'Syne', sans-serif;
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 7px;
}

/* ===================== FORM ===================== */
.form-group { margin-bottom: 14px; }
.form-group:last-child { margin-bottom: 0; }

.form-group label {
  display: block;
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 5px;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 11px 14px;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.92rem;
  color: var(--text);
  background: var(--bg);
  outline: none;
  transition: border-color 0.18s, box-shadow 0.18s;
  -webkit-appearance: none;
}

.form-group input:focus,
.form-group select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(30,61,15,0.09); }
.form-group input.error { border-color: var(--red); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* ===================== QTY CONTROL ===================== */
.qty-control {
  display: flex;
  align-items: center;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  overflow: hidden;
  background: var(--bg);
  width: 120px;
}

.qty-control button {
  width: 36px;
  height: 42px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 1.1rem;
  color: var(--text2);
  transition: background 0.15s;
  flex-shrink: 0;
}

.qty-control button:active { background: var(--card); }

.qty-control input {
  flex: 1;
  text-align: center;
  border: none !important;
  background: transparent !important;
  padding: 0 !important;
  font-size: 0.9rem;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
  color: var(--text);
  outline: none;
  box-shadow: none !important;
  width: 44px;
}

/* ===================== PRIORITY ===================== */
.prio-select { display: flex; gap: 6px; }

.prio-opt {
  flex: 1;
  padding: 8px 4px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  text-align: center;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  color: var(--muted);
  background: var(--bg);
}

.prio-opt.selected[data-p="1"] { background: var(--red-bg); border-color: var(--red); color: var(--red); }
.prio-opt.selected[data-p="2"] { background: var(--amber-bg); border-color: var(--amber); color: var(--amber); }
.prio-opt.selected[data-p="3"] { background: var(--accent-bg); border-color: var(--accent-mid); color: var(--accent-mid); }

/* ===================== SKU AUTOCOMPLETE ===================== */
.sku-input-wrap { position: relative; }

.sku-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--surface);
  border: 1.5px solid var(--accent);
  border-radius: 10px;
  box-shadow: var(--shadow-lg);
  z-index: 200;
  max-height: 240px;
  overflow-y: auto;
}

.sku-option {
  padding: 11px 14px;
  cursor: pointer;
  font-size: 0.88rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.1s;
  border-bottom: 1px solid var(--border);
}

.sku-option:last-child { border-bottom: none; }
.sku-option:hover, .sku-option:active { background: var(--card); }
.sku-option .so-sku { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--accent-mid); }
.sku-option .so-name { color: var(--text); font-weight: 500; font-size: 0.85rem; }
.sku-option .so-stock { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; }

/* ===================== ORDER RESULT ===================== */
.order-result {
  background: var(--card);
  border: 1.5px solid var(--border2);
  border-radius: 10px;
  padding: 14px 16px;
  margin-top: 12px;
  font-size: 0.87rem;
}

.order-result.success { background: var(--accent-bg); border-color: rgba(30,61,15,0.2); }
.order-result.added { background: var(--amber-bg); border-color: rgba(184,110,16,0.2); }

.order-result-title {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.order-result.success .order-result-title { color: var(--accent-mid); }
.order-result.added .order-result-title { color: var(--amber); }
.order-result p { color: var(--text2); line-height: 1.5; font-size: 0.84rem; }

/* ===================== QUEUE ===================== */
.queue-list { display: flex; flex-direction: column; gap: 10px; }

.queue-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  box-shadow: var(--shadow);
  animation: slideUp 0.25s ease;
}

@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.queue-item.done { opacity: 0.45; border-style: dashed; }

.qi-top {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.queue-pos {
  width: 38px;
  height: 38px;
  background: var(--accent);
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 800;
  color: white;
  flex-shrink: 0;
}

.queue-pos.high { background: var(--red); }
.queue-pos.low { background: var(--muted); }

.qi-name { font-weight: 600; font-size: 0.92rem; flex: 1; }

.qi-meta {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.queue-chip {
  font-size: 0.68rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  background: var(--card);
  padding: 2px 8px;
  border-radius: 4px;
  border: 1px solid var(--border);
}

.queue-chip.qty { color: var(--accent-mid); background: var(--accent-bg); border-color: rgba(45,90,24,0.15); }
.queue-chip.deadline { color: var(--amber); background: var(--amber-bg); border-color: rgba(184,110,16,0.2); }
.queue-chip.deadline.urgent { color: var(--red); background: var(--red-bg); border-color: rgba(181,45,32,0.2); }
.queue-chip.who { color: var(--accent-mid); }

.qi-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ===================== TABLE (catalog/stock) ===================== */
.table-wrap {
  overflow-x: auto;
  border-radius: 12px;
  box-shadow: var(--shadow);
  -webkit-overflow-scrolling: touch;
}

table { width: 100%; border-collapse: collapse; background: var(--surface); min-width: 500px; }

thead tr { background: var(--card); border-bottom: 2px solid var(--border); }

th {
  padding: 11px 14px;
  text-align: left;
  font-size: 0.68rem;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  white-space: nowrap;
}

td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 0.88rem; vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--card); }

.sku-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.74rem;
  background: var(--accent-bg);
  color: var(--accent-mid);
  padding: 3px 8px;
  border-radius: 5px;
  font-weight: 500;
  border: 1px solid rgba(45,90,24,0.15);
  white-space: nowrap;
}

.stock-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.74rem;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
  white-space: nowrap;
}

.stock-ok { background: var(--accent-bg); color: var(--accent-mid); }
.stock-low { background: var(--amber-bg); color: var(--amber); }
.stock-out { background: var(--red-bg); color: var(--red); }

/* ===================== MODAL ===================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(18,14,10,0.55);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: 0;
  animation: fadeIn 0.15s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.modal {
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-width: 540px;
  animation: sheetUp 0.25s ease;
  border: 1px solid var(--border);
  max-height: 90vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.modal-handle {
  width: 36px; height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 12px auto 0;
}

.modal-header { padding: 16px 20px 0; display: flex; align-items: center; justify-content: space-between; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--accent); }
.modal-close {
  width: 30px; height: 30px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: transparent;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: var(--muted);
  font-size: 1rem;
  transition: all 0.15s;
}
.modal-close:hover { background: var(--red-bg); color: var(--red); }

.modal-body { padding: 16px 20px; }
.modal-footer { padding: 0 20px 24px; display: flex; gap: 8px; justify-content: flex-end; }

/* ===================== MISC ===================== */
.section-title {
  font-family: 'Syne', sans-serif;
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--muted);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.empty {
  text-align: center;
  padding: 48px 20px;
  color: var(--muted);
}

.empty-icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.35; }
.empty-title { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700; margin-bottom: 5px; color: var(--text2); }
.empty-sub { font-size: 0.82rem; }

.search-bar { margin-bottom: 16px; }
.search-bar input {
  width: 100%;
  padding: 10px 16px;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.9rem;
  background: var(--surface);
  outline: none;
  transition: border-color 0.18s;
  color: var(--text);
  -webkit-appearance: none;
}
.search-bar input:focus { border-color: var(--accent); }

/* NOTIFICATION */
.notification {
  position: fixed;
  bottom: calc(var(--bottom-nav-h) + 12px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: white;
  padding: 12px 20px;
  border-radius: 50px;
  font-size: 0.85rem;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  z-index: 2000;
  animation: notifIn 0.25s ease;
  white-space: nowrap;
  max-width: calc(100vw - 40px);
  text-overflow: ellipsis;
  overflow: hidden;
}

@keyframes notifIn { from { opacity:0; transform: translateX(-50%) translateY(10px); } to { opacity:1; transform: translateX(-50%) translateY(0); } }

.notification.warn { background: var(--amber); }
.notification.error { background: var(--red); }

/* REFRESH indicator */
.refresh-dot {
  width: 8px; height: 8px;
  background: #8fcf5a;
  border-radius: 50%;
  display: inline-block;
  animation: blink 2s ease-in-out infinite;
}

@keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0.3; } }

/* RECENT orders list */
.recent-list { display: flex; flex-direction: column; gap: 8px; }
.recent-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 9px;
  padding: 10px 12px;
  font-size: 0.83rem;
}
.recent-item-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 5px; }
.recent-item-name { font-weight: 600; color: var(--text); }
.recent-item-time { font-size: 0.68rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; white-space: nowrap; flex-shrink: 0; }
.recent-chips { display: flex; gap: 5px; flex-wrap: wrap; }

/* DESKTOP LAYOUT */
@media (min-width: 768px) {
  .main-scroll { padding-bottom: 24px; padding: 28px 32px; }
  .bottom-nav { display: none !important; }
  .desktop-nav { display: flex; }
  .stats-row { grid-template-columns: repeat(4, 1fr); }
  .order-desktop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .modal-overlay { align-items: center; padding: 20px; }
  .modal { border-radius: 16px; max-width: 480px; }
  @keyframes sheetUp { from { opacity:0; transform: translateY(16px); } to { opacity:1; transform: translateY(0); } }
  .modal-handle { display: none; }
  .notification { bottom: 24px; }
}

@media (max-width: 767px) {
  .bottom-nav { display: flex; }
  .desktop-nav { display: none; }
  header { padding: 0 16px; }
  .main-scroll { padding: 16px 16px calc(var(--bottom-nav-h) + 16px); }
}

/* SCROLLBAR */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>

<!-- ==================== LOGIN SCREEN ==================== -->
<div id="login-screen">
  <div class="login-logo">Set<span>Groom</span></div>
  <div class="login-sub">System zarzƒÖdzania produkcjƒÖ</div>
  <div class="login-label">Wybierz swoje stanowisko</div>
  <div class="login-cards">
    <div class="login-card" onclick="login('biuro')">
      <div class="login-card-icon">üíº</div>
      <div class="login-card-name">Biuro</div>
      <div class="login-card-desc">Przyjmowanie zam√≥wie≈Ñ, katalog produkt√≥w, magazyn</div>
    </div>
    <div class="login-card" onclick="login('produkcja')">
      <div class="login-card-icon">üî®</div>
      <div class="login-card-name">Produkcja</div>
      <div class="login-card-desc">Kolejka produkcyjna, oznaczanie uko≈Ñczonych zlece≈Ñ</div>
    </div>
  </div>
</div>

<!-- ==================== APP SHELL ==================== -->
<div id="app-shell">

  <header>
    <div class="logo">Set<span>Groom</span></div>

    <!-- Desktop nav -->
    <nav class="desktop-nav" id="desktop-nav">
      <button class="nav-tab active" onclick="switchView('orders')" id="tab-orders" data-role="biuro">
        üì¶ Zam√≥wienia
      </button>
      <button class="nav-tab" onclick="switchView('queue')" id="tab-queue">
        ‚öô Kolejka <span class="nav-badge" id="queue-count-nav">0</span>
      </button>
      <button class="nav-tab" onclick="switchView('catalog')" id="tab-catalog" data-role="biuro">
        üìã Katalog
      </button>
      <button class="nav-tab" onclick="switchView('stock')" id="tab-stock" data-role="biuro">
        üè≠ Magazyn
      </button>
    </nav>

    <div class="header-right">
      <div class="user-pill">
        <span class="user-pill-icon" id="user-icon">üíº</span>
        <span id="user-name-header">Biuro</span>
      </div>
      <span class="refresh-dot" title="Dane synchronizowane"></span>
      <button class="btn-logout" onclick="logout()">Wyloguj</button>
    </div>
  </header>

  <div class="main-scroll" id="main-scroll">

    <!-- ===== ZAM√ìWIENIA ===== -->
    <div class="view active" id="view-orders">
      <div class="page-header">
        <div>
          <div class="page-title">Nowe zam√≥wienie</div>
          <div class="page-subtitle">Sprawd≈∫ stan i dodaj do kolejki produkcyjnej</div>
        </div>
      </div>

      <div class="stats-row" id="stats-row">
        <div class="stat-card">
          <div class="stat-label">Produkty</div>
          <div class="stat-value" id="stat-products">0</div>
          <div class="stat-sub">w katalogu</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Na stanie</div>
          <div class="stat-value" id="stat-instock">0</div>
          <div class="stat-sub">gotowe</div>
        </div>
        <div class="stat-card warn">
          <div class="stat-label">Kolejka</div>
          <div class="stat-value" id="stat-queue">0</div>
          <div class="stat-sub">do produkcji</div>
        </div>
        <div class="stat-card danger">
          <div class="stat-label">Brak towaru</div>
          <div class="stat-value" id="stat-outofstock">0</div>
          <div class="stat-sub">produkt√≥w</div>
        </div>
      </div>

      <div class="order-desktop-grid">
        <div class="order-form-card">
          <div class="panel-title">üì¶ Wprowad≈∫ zam√≥wienie</div>

          <div class="form-group">
            <label>SKU produktu</label>
            <div class="sku-input-wrap">
              <input type="text" id="order-sku" placeholder="Wpisz SKU lub nazwƒô..." autocomplete="off"
                oninput="skuAutocomplete(this.value)" onkeydown="skuKeydown(event)" onblur="setTimeout(closeSkuDropdown,200)">
              <div class="sku-dropdown" id="sku-dropdown" style="display:none"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Ilo≈õƒá</label>
              <div class="qty-control">
                <button onclick="changeQty('order-qty',-1)">‚àí</button>
                <input type="number" id="order-qty" value="1" min="1">
                <button onclick="changeQty('order-qty',1)">+</button>
              </div>
            </div>
            <div class="form-group">
              <label>Termin (opcjonalnie)</label>
              <input type="date" id="order-deadline">
            </div>
          </div>

          <div class="form-group">
            <label>Priorytet</label>
            <div class="prio-select" id="prio-select">
              <div class="prio-opt" data-p="1" onclick="selectPrio(1)">üî¥ Wysoki</div>
              <div class="prio-opt selected" data-p="2" onclick="selectPrio(2)">üü° Normalny</div>
              <div class="prio-opt" data-p="3" onclick="selectPrio(3)">üü¢ Niski</div>
            </div>
          </div>

          <button class="btn btn-primary btn-full" onclick="processOrder()">
            ‚úì Realizuj zam√≥wienie
          </button>

          <div id="order-result"></div>
        </div>

        <div class="order-form-card">
          <div class="panel-title">üìå Ostatnie zam√≥wienia</div>
          <div id="recent-orders">
            <div class="empty">
              <div class="empty-icon">üìã</div>
              <div class="empty-title">Brak historii</div>
              <div class="empty-sub">Tutaj pojawiƒÖ siƒô ostatnie zam√≥wienia</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== KOLEJKA ===== -->
    <div class="view" id="view-queue">
      <div class="page-header">
        <div>
          <div class="page-title">Kolejka produkcyjna</div>
          <div class="page-subtitle">Zlecenia do wyprodukowania</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="clearDoneQueue()">üóë Usu≈Ñ uko≈Ñczone</button>
      </div>
      <div id="queue-container"></div>
    </div>

    <!-- ===== KATALOG ===== -->
    <div class="view" id="view-catalog">
      <div class="page-header">
        <div>
          <div class="page-title">Katalog produkt√≥w</div>
          <div class="page-subtitle">ZarzƒÖdzaj produktami i SKU</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openAddProduct()">+ Dodaj produkt</button>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="Szukaj po nazwie lub SKU..." oninput="filterCatalog(this.value)">
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Nazwa produktu</th>
              <th>Opis</th>
              <th>Cena</th>
              <th>Stan</th>
              <th>Min.</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="catalog-body"></tbody>
        </table>
      </div>
    </div>

    <!-- ===== MAGAZYN ===== -->
    <div class="view" id="view-stock">
      <div class="page-header">
        <div>
          <div class="page-title">Magazyn</div>
          <div class="page-subtitle">Aktualizuj stany po produkcji lub dostawie</div>
        </div>
      </div>

      <div class="section-title" style="margin-bottom:12px">Alerty stan√≥w</div>
      <div id="stock-alerts" style="margin-bottom:24px"></div>

      <div class="section-title">Wszystkie produkty</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Nazwa</th>
              <th>Stan</th>
              <th>Min.</th>
              <th>Aktualizuj</th>
            </tr>
          </thead>
          <tbody id="stock-body"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /main-scroll -->

  <!-- Bottom nav (mobile) -->
  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="bnav-item active" onclick="switchView('orders')" id="bnav-orders">
        <div class="bnav-icon">üì¶</div>
        <div class="bnav-label">Zam√≥wienia</div>
      </button>
      <button class="bnav-item" onclick="switchView('queue')" id="bnav-queue">
        <div class="bnav-icon">‚öô<span class="bnav-badge" id="queue-count-bnav" style="display:none">0</span></div>
        <div class="bnav-label">Kolejka</div>
      </button>
      <button class="bnav-item" onclick="switchView('catalog')" id="bnav-catalog">
        <div class="bnav-icon">üìã</div>
        <div class="bnav-label">Katalog</div>
      </button>
      <button class="bnav-item" onclick="switchView('stock')" id="bnav-stock">
        <div class="bnav-icon">üè≠</div>
        <div class="bnav-label">Magazyn</div>
      </button>
    </div>
  </nav>

</div><!-- /app-shell -->

<!-- ==================== MODAL: PRODUKT ==================== -->
<div class="modal-overlay" id="modal-product" style="display:none" onclick="if(event.target===this)closeModal('modal-product')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="modal-product-title">Dodaj produkt</div>
      <button class="modal-close" onclick="closeModal('modal-product')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>SKU *</label>
          <input type="text" id="p-sku" placeholder="POD-M-OAK-01" style="text-transform:uppercase">
        </div>
        <div class="form-group">
          <label>Cena (PLN)</label>
          <input type="number" id="p-price" placeholder="0.00" min="0" step="0.01">
        </div>
      </div>
      <div class="form-group">
        <label>Nazwa produktu *</label>
        <input type="text" id="p-name" placeholder="Podest dla psa M ‚Äî DƒÖb naturalny">
      </div>
      <div class="form-group">
        <label>Opis (opcjonalnie)</label>
        <input type="text" id="p-desc" placeholder="np. wymiary, materia≈Ç, kolor...">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Stan magazynu</label>
          <input type="number" id="p-stock" value="0" min="0">
        </div>
        <div class="form-group">
          <label>Minimalny stan</label>
          <input type="number" id="p-min" value="2" min="0">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-product')">Anuluj</button>
      <button class="btn btn-primary" onclick="saveProduct()">Zapisz</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let products = [];
let queue = [];
let orderHistory = [];
let selectedPrio = 2;
let editingProductId = null;
let currentUser = null; // 'biuro' | 'produkcja'
let syncInterval = null;
let catalogFilter = '';

// ============================================================
// LOGIN / LOGOUT
// ============================================================
function login(role) {
  currentUser = role;
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app-shell').style.display = 'flex';

  const isProdukcja = role === 'produkcja';
  document.getElementById('user-name-header').textContent = isProdukcja ? 'Produkcja' : 'Biuro';
  document.getElementById('user-icon').textContent = isProdukcja ? 'üî®' : 'üíº';

  // Je≈õli produkcja ‚Äî prze≈ÇƒÖcz od razu na kolejkƒô
  if (isProdukcja) {
    switchView('queue');
  } else {
    switchView('orders');
  }

  loadData();

  // Auto-refresh co 10 sekund (synchronizacja danych miƒôdzy u≈ºytkownikami)
  clearInterval(syncInterval);
  syncInterval = setInterval(silentRefresh, 10000);
}

function logout() {
  clearInterval(syncInterval);
  currentUser = null;
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app-shell').style.display = 'none';
}

// ============================================================
// STORAGE (shared = true ‚Üí wsp√≥lne dla obu u≈ºytkownik√≥w)
// ============================================================
async function loadData() {
  try {
    const pr = await window.storage.get('sg-products', true);
    if (pr) products = JSON.parse(pr.value);
  } catch(e) { products = []; }

  try {
    const qu = await window.storage.get('sg-queue', true);
    if (qu) queue = JSON.parse(qu.value);
  } catch(e) { queue = []; }

  try {
    const oh = await window.storage.get('sg-orders', true);
    if (oh) orderHistory = JSON.parse(oh.value);
  } catch(e) { orderHistory = []; }

  render();
}

async function save() {
  try { await window.storage.set('sg-products', JSON.stringify(products), true); } catch(e){}
  try { await window.storage.set('sg-queue', JSON.stringify(queue), true); } catch(e){}
  try { await window.storage.set('sg-orders', JSON.stringify(orderHistory), true); } catch(e){}
}

async function silentRefresh() {
  // Cicho od≈õwie≈ºa dane z serwera bez resetowania UI
  let changed = false;
  try {
    const pr = await window.storage.get('sg-products', true);
    if (pr) { const d = JSON.parse(pr.value); if (JSON.stringify(d) !== JSON.stringify(products)) { products = d; changed = true; } }
  } catch(e){}
  try {
    const qu = await window.storage.get('sg-queue', true);
    if (qu) { const d = JSON.parse(qu.value); if (JSON.stringify(d) !== JSON.stringify(queue)) { queue = d; changed = true; } }
  } catch(e){}
  try {
    const oh = await window.storage.get('sg-orders', true);
    if (oh) { const d = JSON.parse(oh.value); if (JSON.stringify(d) !== JSON.stringify(orderHistory)) { orderHistory = d; changed = true; } }
  } catch(e){}

  if (changed) { render(); }
}

// ============================================================
// NAVIGATION
// ============================================================
function switchView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.bnav-item').forEach(t => t.classList.remove('active'));

  document.getElementById('view-' + name).classList.add('active');
  const dt = document.getElementById('tab-' + name);
  if (dt) dt.classList.add('active');
  const bn = document.getElementById('bnav-' + name);
  if (bn) bn.classList.add('active');

  document.getElementById('main-scroll').scrollTop = 0;
  render();
}

// ============================================================
// RENDER
// ============================================================
function render() {
  renderStats();
  renderCatalog(catalogFilter);
  renderQueue();
  renderStock();
  renderRecentOrders();
}

function renderStats() {
  const total = products.length;
  const inStock = products.filter(p => p.stock > 0).length;
  const queueCount = queue.filter(q => !q.done).length;
  const outOf = products.filter(p => p.stock === 0).length;

  setEl('stat-products', total);
  setEl('stat-instock', inStock);
  setEl('stat-queue', queueCount);
  setEl('stat-outofstock', outOf);
  setEl('queue-count-nav', queueCount);

  const bnav = document.getElementById('queue-count-bnav');
  if (bnav) { bnav.textContent = queueCount; bnav.style.display = queueCount > 0 ? 'block' : 'none'; }
}

function setEl(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function renderCatalog(filter = '') {
  const body = document.getElementById('catalog-body');
  if (!body) return;
  const f = filter.toLowerCase();
  const list = f ? products.filter(p =>
    p.name.toLowerCase().includes(f) || p.sku.toLowerCase().includes(f)
  ) : products;

  if (list.length === 0) {
    body.innerHTML = `<tr><td colspan="7"><div class="empty">
      <div class="empty-icon">üì¶</div>
      <div class="empty-title">${filter ? 'Brak wynik√≥w' : 'Brak produkt√≥w'}</div>
      <div class="empty-sub">${filter ? 'Zmie≈Ñ wyszukiwanie' : 'Kliknij "+ Dodaj produkt"'}</div>
    </div></td></tr>`;
    return;
  }

  body.innerHTML = list.map(p => {
    const sc = p.stock === 0 ? 'stock-out' : p.stock <= p.minStock ? 'stock-low' : 'stock-ok';
    const si = p.stock === 0 ? '‚äò' : p.stock <= p.minStock ? '‚ö†' : '‚úì';
    return `<tr>
      <td><span class="sku-badge">${p.sku}</span></td>
      <td><strong>${p.name}</strong></td>
      <td style="color:var(--muted);font-size:0.8rem">${p.desc || '‚Äî'}</td>
      <td style="font-size:0.85rem">${p.price ? p.price.toFixed(2)+' z≈Ç' : '‚Äî'}</td>
      <td><span class="stock-badge ${sc}">${si} ${p.stock} szt.</span></td>
      <td style="color:var(--muted);font-size:0.82rem">${p.minStock}</td>
      <td>
        <div style="display:flex;gap:5px">
          <button class="btn btn-secondary btn-sm" onclick="openEditProduct('${p.id}')">‚úè</button>
          <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')">üóë</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function renderQueue() {
  const container = document.getElementById('queue-container');
  if (!container) return;
  const active = queue.filter(q => !q.done);
  const done = queue.filter(q => q.done);
  const today = new Date(); today.setHours(0,0,0,0);

  if (active.length === 0 && done.length === 0) {
    container.innerHTML = `<div class="empty">
      <div class="empty-icon">‚úÖ</div>
      <div class="empty-title">Kolejka pusta</div>
      <div class="empty-sub">Wszystko wyprodukowane lub brak zlece≈Ñ</div>
    </div>`;
    return;
  }

  let html = '';

  if (active.length > 0) {
    html += `<div class="section-title" style="margin-bottom:14px">Do wyprodukowania (${active.length})</div>`;
    html += `<div class="queue-list" style="margin-bottom:24px">`;
    active.forEach((item, idx) => {
      const posClass = item.priority === 1 ? 'high' : item.priority === 3 ? 'low' : '';
      const isUrgent = item.deadline && new Date(item.deadline) < new Date(today.getTime() + 2 * 86400000);
      html += `<div class="queue-item" id="qi-${item.id}">
        <div class="qi-top">
          <div class="queue-pos ${posClass}">${idx + 1}</div>
          <div class="qi-name">${item.productName}</div>
        </div>
        <div class="qi-meta">
          <span class="queue-chip">${item.sku}</span>
          <span class="queue-chip qty">üì¶ ${item.qty} szt.</span>
          ${item.deadline ? `<span class="queue-chip deadline${isUrgent?' urgent':''}">‚è∞ ${formatDate(item.deadline)}</span>` : ''}
          <span class="queue-chip">${['','üî¥ Wysoki','üü° Normalny','üü¢ Niski'][item.priority]}</span>
          <span class="queue-chip">${item.addedBy === 'biuro' ? 'üíº Biuro' : 'üî® Produkcja'}</span>
          <span class="queue-chip" style="color:var(--muted)">${formatDateTime(item.addedAt)}</span>
        </div>
        <div class="qi-actions">
          <button class="btn btn-success btn-sm" onclick="markDone('${item.id}')">‚úì Wyprodukowano</button>
          <button class="btn btn-danger btn-sm" onclick="removeQueueItem('${item.id}')">üóë</button>
        </div>
      </div>`;
    });
    html += `</div>`;
  }

  if (done.length > 0) {
    html += `<div class="section-title" style="margin-bottom:14px">Uko≈Ñczone (${done.length})</div>`;
    html += `<div class="queue-list">`;
    done.forEach(item => {
      html += `<div class="queue-item done">
        <div class="qi-top">
          <div class="queue-pos" style="background:var(--muted)">‚úì</div>
          <div class="qi-name" style="text-decoration:line-through;opacity:0.6">${item.productName}</div>
        </div>
        <div class="qi-meta">
          <span class="queue-chip">${item.sku}</span>
          <span class="queue-chip qty">üì¶ ${item.qty} szt.</span>
          ${item.doneAt ? `<span class="queue-chip">Uko≈Ñczono: ${formatDateTime(item.doneAt)}</span>` : ''}
        </div>
        <div class="qi-actions">
          <button class="btn btn-danger btn-sm" onclick="removeQueueItem('${item.id}')">üóë Usu≈Ñ</button>
        </div>
      </div>`;
    });
    html += `</div>`;
  }

  container.innerHTML = html;
}

function renderStock() {
  const alerts = products.filter(p => p.stock <= p.minStock);
  const alertsDiv = document.getElementById('stock-alerts');
  if (alertsDiv) {
    if (alerts.length === 0) {
      alertsDiv.innerHTML = `<div style="color:var(--accent-mid);font-size:0.85rem;padding:10px 0">‚úÖ Wszystkie stany magazynowe w normie.</div>`;
    } else {
      alertsDiv.innerHTML = `<div class="queue-list">${alerts.map(p => `
        <div class="queue-item" style="border-left:3px solid var(--${p.stock===0?'red':'amber'})">
          <div class="qi-top">
            <div class="queue-pos" style="background:var(--${p.stock===0?'red':'amber'})">${p.stock===0?'‚äò':'!'}</div>
            <div class="qi-name">${p.name}</div>
          </div>
          <div class="qi-meta">
            <span class="queue-chip">${p.sku}</span>
            <span class="queue-chip" style="color:var(--${p.stock===0?'red':'amber'})">${p.stock===0?'BRAK TOWARU':'Niski stan: '+p.stock+' szt.'}</span>
            <span class="queue-chip">Min: ${p.minStock} szt.</span>
          </div>
        </div>`).join('')}</div>`;
    }
  }

  const body = document.getElementById('stock-body');
  if (!body) return;
  if (products.length === 0) {
    body.innerHTML = `<tr><td colspan="5"><div class="empty"><div class="empty-icon">üì¶</div><div class="empty-title">Brak produkt√≥w</div></div></td></tr>`;
    return;
  }

  body.innerHTML = products.map(p => {
    const sc = p.stock === 0 ? 'stock-out' : p.stock <= p.minStock ? 'stock-low' : 'stock-ok';
    const si = p.stock === 0 ? '‚äò' : p.stock <= p.minStock ? '‚ö†' : '‚úì';
    return `<tr>
      <td><span class="sku-badge">${p.sku}</span></td>
      <td><strong style="font-size:0.85rem">${p.name}</strong></td>
      <td><span class="stock-badge ${sc}">${si} ${p.stock}</span></td>
      <td style="color:var(--muted);font-size:0.82rem">${p.minStock}</td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="qty-control">
            <button onclick="changeQty('sq-${p.id}',-1)">‚àí</button>
            <input type="number" id="sq-${p.id}" value="${p.stock}" min="0">
            <button onclick="changeQty('sq-${p.id}',1)">+</button>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="updateStock('${p.id}')">üíæ</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function renderRecentOrders() {
  const div = document.getElementById('recent-orders');
  if (!div) return;

  if (orderHistory.length === 0) {
    div.innerHTML = `<div class="empty">
      <div class="empty-icon">üìã</div>
      <div class="empty-title">Brak historii</div>
      <div class="empty-sub">Tutaj pojawiƒÖ siƒô ostatnie zam√≥wienia</div>
    </div>`;
    return;
  }

  const recent = [...orderHistory].reverse().slice(0, 10);
  div.innerHTML = `<div class="recent-list">${recent.map(o => `
    <div class="recent-item">
      <div class="recent-item-top">
        <div class="recent-item-name">${o.productName}</div>
        <div class="recent-item-time">${formatDateTime(o.time)}</div>
      </div>
      <div class="recent-chips">
        <span class="queue-chip">${o.sku}</span>
        <span class="queue-chip qty">üì¶ ${o.qty} szt.</span>
        <span class="queue-chip">${o.action === 'stock' ? '‚úì Z magazynu' : '‚öô Do produkcji'}</span>
        <span class="queue-chip">${o.by === 'biuro' ? 'üíº' : 'üî®'} ${o.by === 'biuro' ? 'Biuro' : 'Produkcja'}</span>
      </div>
    </div>`).join('')}
  </div>`;
}

// ============================================================
// ORDER
// ============================================================
function processOrder() {
  const skuRaw = document.getElementById('order-sku').value.trim().toUpperCase();
  const qty = parseInt(document.getElementById('order-qty').value) || 1;
  const deadline = document.getElementById('order-deadline').value;
  const resultDiv = document.getElementById('order-result');

  if (!skuRaw) {
    document.getElementById('order-sku').classList.add('error');
    setTimeout(() => document.getElementById('order-sku').classList.remove('error'), 2000);
    return;
  }

  const product = products.find(p => p.sku === skuRaw);

  if (!product) {
    resultDiv.innerHTML = `<div class="order-result">
      <div class="order-result-title">‚äò Nieznane SKU</div>
      <p>Produkt <strong>${skuRaw}</strong> nie istnieje w katalogu.</p>
    </div>`;
    return;
  }

  if (product.stock >= qty) {
    product.stock -= qty;
    orderHistory.push({ id: uid(), sku: product.sku, productName: product.name, qty, time: new Date().toISOString(), action: 'stock', by: currentUser });
    save();

    resultDiv.innerHTML = `<div class="order-result success">
      <div class="order-result-title">‚úÖ Dostƒôpne na stanie!</div>
      <p><strong>${product.name}</strong> (${qty} szt.) wydano z magazynu.<br>Pozosta≈Ço: <strong>${product.stock} szt.</strong></p>
    </div>`;

    notify(`‚úì Wydano ${qty} szt. z magazynu`);
    scheduleClearForm();
  } else {
    const neededQty = qty - product.stock;
    if (product.stock > 0) product.stock = 0;

    queue.push({
      id: uid(),
      sku: product.sku,
      productName: product.name,
      qty: neededQty,
      priority: selectedPrio,
      deadline: deadline || null,
      addedAt: new Date().toISOString(),
      addedBy: currentUser,
      done: false
    });

    orderHistory.push({ id: uid(), sku: product.sku, productName: product.name, qty, time: new Date().toISOString(), action: 'queue', by: currentUser });
    save();

    resultDiv.innerHTML = `<div class="order-result added">
      <div class="order-result-title">‚öô Dodano do kolejki produkcyjnej</div>
      <p>Brak wystarczajƒÖcego stanu.<br><strong>${neededQty} szt.</strong> dodano do kolejki.</p>
    </div>`;

    notify(`‚öô ${product.name} ‚Äî ${neededQty} szt. w kolejce`, 'warn');
    scheduleClearForm();
  }

  render();
}

let clearFormTimer;
function scheduleClearForm() {
  clearTimeout(clearFormTimer);
  clearFormTimer = setTimeout(() => {
    document.getElementById('order-sku').value = '';
    document.getElementById('order-qty').value = 1;
    document.getElementById('order-deadline').value = '';
    document.getElementById('order-result').innerHTML = '';
    selectPrio(2);
  }, 4000);
}

// ============================================================
// QUEUE ACTIONS
// ============================================================
function markDone(id) {
  const item = queue.find(q => q.id === id);
  if (!item) return;
  item.done = true;
  item.doneAt = new Date().toISOString();
  item.doneBy = currentUser;
  save();
  renderQueue();
  renderStats();
  notify(`‚úì ${item.productName} ‚Äî oznaczono jako wyprodukowane!`);
}

function removeQueueItem(id) {
  queue = queue.filter(q => q.id !== id);
  save();
  renderQueue();
  renderStats();
}

function clearDoneQueue() {
  const count = queue.filter(q => q.done).length;
  if (count === 0) { notify('Brak uko≈Ñczonych pozycji'); return; }
  queue = queue.filter(q => !q.done);
  save();
  renderQueue();
  renderStats();
  notify(`üóë Usuniƒôto ${count} uko≈Ñczone pozycje`);
}

// ============================================================
// STOCK
// ============================================================
function updateStock(productId) {
  const input = document.getElementById('sq-' + productId);
  const val = parseInt(input.value);
  if (isNaN(val) || val < 0) return;
  const p = products.find(p => p.id === productId);
  if (!p) return;
  p.stock = val;
  save();
  renderStock();
  renderStats();
  notify(`üíæ Stan "${p.name}" zaktualizowany: ${val} szt.`);
}

// ============================================================
// CATALOG CRUD
// ============================================================
function openAddProduct() {
  editingProductId = null;
  document.getElementById('modal-product-title').textContent = 'Dodaj produkt';
  ['p-sku','p-name','p-desc','p-price'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('p-stock').value = '0';
  document.getElementById('p-min').value = '2';
  document.getElementById('p-sku').disabled = false;
  document.getElementById('modal-product').style.display = 'flex';
}

function openEditProduct(id) {
  const p = products.find(p => p.id === id);
  if (!p) return;
  editingProductId = id;
  document.getElementById('modal-product-title').textContent = 'Edytuj produkt';
  document.getElementById('p-sku').value = p.sku;
  document.getElementById('p-name').value = p.name;
  document.getElementById('p-desc').value = p.desc || '';
  document.getElementById('p-price').value = p.price || '';
  document.getElementById('p-stock').value = p.stock;
  document.getElementById('p-min').value = p.minStock;
  document.getElementById('p-sku').disabled = true;
  document.getElementById('modal-product').style.display = 'flex';
}

function saveProduct() {
  const sku = document.getElementById('p-sku').value.trim().toUpperCase();
  const name = document.getElementById('p-name').value.trim();
  const desc = document.getElementById('p-desc').value.trim();
  const price = parseFloat(document.getElementById('p-price').value) || 0;
  const stock = parseInt(document.getElementById('p-stock').value) || 0;
  const minStock = parseInt(document.getElementById('p-min').value) || 0;

  if (!sku) { document.getElementById('p-sku').classList.add('error'); return; }
  if (!name) { document.getElementById('p-name').classList.add('error'); return; }

  if (editingProductId) {
    const p = products.find(p => p.id === editingProductId);
    if (p) Object.assign(p, { name, desc, price, stock, minStock });
  } else {
    if (products.find(p => p.sku === sku)) {
      notify('SKU ju≈º istnieje!', 'error');
      document.getElementById('p-sku').classList.add('error');
      return;
    }
    products.push({ id: uid(), sku, name, desc, price, stock, minStock });
  }

  save();
  render();
  closeModal('modal-product');
  notify(editingProductId ? '‚úì Produkt zaktualizowany' : `‚úì Produkt ${sku} dodany`);
}

function deleteProduct(id) {
  const p = products.find(p => p.id === id);
  if (!p || !confirm(`UsunƒÖƒá "${p.name}"?`)) return;
  products = products.filter(p => p.id !== id);
  save();
  render();
  notify(`üóë Usuniƒôto: ${p.name}`);
}

// ============================================================
// SKU AUTOCOMPLETE
// ============================================================
function skuAutocomplete(val) {
  const dd = document.getElementById('sku-dropdown');
  const v = val.trim().toUpperCase();
  if (!v) { dd.style.display = 'none'; return; }

  const matches = products.filter(p =>
    p.sku.includes(v) || p.name.toUpperCase().includes(v)
  ).slice(0, 7);

  if (!matches.length) { dd.style.display = 'none'; return; }

  dd.innerHTML = matches.map(p => {
    const col = p.stock === 0 ? 'var(--red)' : p.stock <= p.minStock ? 'var(--amber)' : 'var(--accent-mid)';
    return `<div class="sku-option" onclick="selectSkuOption('${p.sku}')">
      <div>
        <div class="so-name">${p.name}</div>
        <div class="so-sku">${p.sku}</div>
      </div>
      <div class="so-stock" style="color:${col}">${p.stock} szt.</div>
    </div>`;
  }).join('');
  dd.style.display = 'block';
}

function selectSkuOption(sku) {
  document.getElementById('order-sku').value = sku;
  document.getElementById('sku-dropdown').style.display = 'none';
}

function closeSkuDropdown() {
  const dd = document.getElementById('sku-dropdown');
  if (dd) dd.style.display = 'none';
}

function skuKeydown(e) {
  if (e.key === 'Enter') { closeSkuDropdown(); processOrder(); }
}

// ============================================================
// HELPERS
// ============================================================
function selectPrio(p) {
  selectedPrio = p;
  document.querySelectorAll('.prio-opt').forEach(el =>
    el.classList.toggle('selected', parseInt(el.dataset.p) === p)
  );
}

function filterCatalog(val) {
  catalogFilter = val;
  renderCatalog(val);
}

function changeQty(inputId, delta) {
  const inp = document.getElementById(inputId);
  if (inp) inp.value = Math.max(0, (parseInt(inp.value) || 0) + delta);
}

function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

function formatDate(str) {
  if (!str) return '';
  const d = new Date(str + 'T00:00:00');
  return d.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatDateTime(str) {
  if (!str) return '';
  const d = new Date(str);
  return d.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' }) + ' ' +
    d.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
}

let notifTimeout;
function notify(msg, type = '') {
  const ex = document.getElementById('notif');
  if (ex) ex.remove();
  clearTimeout(notifTimeout);
  const el = document.createElement('div');
  el.id = 'notif';
  el.className = 'notification' + (type ? ' ' + type : '');
  el.textContent = msg;
  document.body.appendChild(el);
  notifTimeout = setTimeout(() => el.remove(), 3500);
}

// Uppercase SKU
document.addEventListener('DOMContentLoaded', () => {
  const skuInput = document.getElementById('order-sku');
  if (skuInput) {
    skuInput.addEventListener('input', function() {
      const pos = this.selectionStart;
      this.value = this.value.toUpperCase();
      this.setSelectionRange(pos, pos);
    });
  }
});
</script>
</body>
</html>
